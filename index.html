<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ­¸æª”ç¥å™¨ v5.1 (å®Œæ•´ç‰ˆ)</title>
    <style>
        :root { --primary: #0d6efd; --purple: #6610f2; --success: #198754; --warning: #ffc107; --danger: #dc3545; --bg: #f8f9fa; --overlay-bg: rgba(0,0,0,0.85); }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å°èˆªåˆ— */
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 5; }
        .nav-title { margin: 0; font-size: 1.2rem; font-weight: bold; }

        .main-layout { display: grid; grid-template-columns: 1fr 420px; gap: 20px; flex: 1; min-height: 0; position: relative; }
        
        /* åœ–ç‰‡å€ */
        .image-panel { background: #222; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .image-panel img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease; }
        .status-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; color: #ff6b6b; font-size: 4rem; font-weight: bold; z-index: 10; flex-direction: column; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { background: white; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-header { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.95rem; display: flex; justify-content: space-between; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-help { background: var(--purple); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 15px; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-help:hover { background: #520dc2; box-shadow: 0 2px 8px rgba(102, 16, 242, 0.3); }

        .btn-upload { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 15px; display: flex; align-items: center; gap: 5px; transition: 0.2s; pointer-events: none; opacity: 0.5; } /* é è¨­é–ä½ */
        .btn-upload.active { pointer-events: auto; opacity: 1; }
        .btn-upload:hover { background: #157347; box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3); }

        .tool-btn { padding: 5px 10px; font-size: 12px; background: #eee; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }

        /* åˆ†é¡æŒ‰éˆ• */
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        .cat-btn, .tag-btn { 
            background: white; border: 1px solid #ccc; padding: 12px 5px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; text-align: center; transition: 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cat-btn:hover, .tag-btn:hover { background: #f8f9fa; border-color: #999; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; }
        .tag-btn.active { background: var(--purple); color: white; border-color: var(--purple); font-weight: bold; }
        
        .key-badge { position: absolute; top: 2px; right: 2px; background: #333; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; opacity: 0.8; font-family: monospace; }
        .cat-btn.active .key-badge, .tag-btn.active .key-badge { background: white; color: #333; }

        .preview-box { background: #e9ecef; padding: 12px; border-radius: 6px; text-align: right; font-family: monospace; font-size: 0.95rem; color: #555; margin-top: auto; border: 1px solid #dee2e6; }
        
        .btn-download { background: #fd7e14; color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: 10px; border: none; border-radius: 6px; cursor: not-allowed; font-weight: bold; opacity: 0.5; }
        .btn-download.active { cursor: pointer; opacity: 1; }
        .btn-download.active:hover { background: #e96b02; }

        /* --- æ­¡è¿ç•«é¢èˆ‡å°å¼• Overlay --- */
        .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .welcome-box { background: white; color: #333; padding: 40px; border-radius: 12px; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .start-btn { padding: 12px 30px; font-size: 1.1rem; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin: 10px; transition: 0.2s; }
        .start-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(13, 110, 253, 0.4); }
        .skip-btn { background: transparent; color: #666; border: 1px solid #ccc; padding: 10px 20px; border-radius: 50px; cursor: pointer; margin: 10px; transition: 0.2s; }
        .skip-btn:hover { background: #f0f0f0; color: #333; }

        /* å°å¼•èšå…‰ç‡ˆ */
        .spotlight { position: relative; z-index: 10000; box-shadow: 0 0 0 9999px var(--overlay-bg); background: white; pointer-events: none; border-radius: 6px; }
        .allow-click { pointer-events: auto !important; cursor: pointer; }
        
        .tour-tooltip { position: fixed; background: white; color: #333; padding: 15px; border-radius: 8px; width: 280px; z-index: 10001; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .tour-step-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-bottom: 5px; display: inline-block; }

        /* --- æ•™å­¸æ‰‹å†Š Modal --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; }
        .modal-body { padding: 30px; overflow-y: auto; line-height: 1.6; }
        
        .help-section { margin-bottom: 30px; }
        .help-title { font-size: 1.1rem; font-weight: bold; color: var(--primary); border-left: 4px solid var(--primary); padding-left: 10px; margin-bottom: 15px; }
        .step-list { list-style: none; padding: 0; }
        .step-list li { margin-bottom: 12px; display: flex; align-items: start; gap: 10px; }
        .step-num { background: #eee; color: #555; min-width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; margin-top: 2px; }
        
        /* å¾©åˆ» Windows è­¦å‘Šæ¨£å¼ */
        .win-alert { border: 1px solid #d9d9d9; background: white; margin: 15px 0; font-family: "Segoe UI", sans-serif; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 500px; }
        .win-title { padding: 8px 12px; font-size: 12px; color: #000; }
        .win-bar { background: #ffcc00; padding: 15px; display: flex; align-items: center; gap: 10px; }
        .win-icon { width: 24px; height: 24px; border: 2px solid #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: serif; font-size: 16px; }
        .win-text { font-size: 16px; color: #000; }
        .win-body { padding: 15px; font-size: 13px; color: #333; }

    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-title">ğŸ“· ç…§ç‰‡æ­¸æª”ç¥å™¨ <span style="font-size:0.8em; font-weight:normal;">v5.1</span></div>
    <div style="display:flex; gap:15px; align-items:center;">
        <button class="tool-btn" onclick="rotateImage()" title="æ—‹è½‰ç…§ç‰‡ (R)">âŸ³ è½‰å‘ (R)</button>
        <button class="btn-help" onclick="openHelpModal()">
            <span>â“ æ•™å­¸</span>
        </button>
        <label for="folderInput" id="uploadBtn" class="btn-upload">
            <span>ğŸ“‚ é¸æ“‡è³‡æ–™å¤¾</span>
        </label>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
    </div>
</div>

<div class="main-layout">
    <div class="image-panel" id="imgPanel">
        <img id="currentImage" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgODAwIDYwMCI+CiAgPHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI2MDAiIGZpbGw9IiMzMzMiIC8+CiAgPHRleHQgeD0iNTA1IiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM4ODgiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjI0Ij7or7fogIXnu4PmhYvkvZzkuLvmiorku7Y8L3RleHQ+Cjwvc3ZnPg==" alt="Demo">
        <div class="status-overlay" id="trashOverlay">
            <div>ğŸ—‘ï¸</div>
            <div style="font-size:1.5rem; color:white;">å·²ä¸Ÿå…¥å›æ”¶æ¡¶</div>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div id="catSection">
            <div class="section-header">ğŸ“‚ ä¸»åˆ†é¡ (éµç›¤ 1-4)</div>
            <div id="catContainer" class="btn-grid"></div>
        </div>

        <div id="tagSection">
            <div class="section-header">ğŸ·ï¸ å­æ¨™ç±¤ (éµç›¤ A-D)</div>
            <div id="tagContainer" class="btn-grid"></div>
        </div>

        <div style="margin-top:auto;">
            <div class="preview-box" id="finalPreview">ç­‰å¾…æ“ä½œ...</div>
            <button id="downloadBtn" class="btn-download" onclick="exportBat()">
                âš¡ ä¸‹è¼‰æ•´ç†åŸ·è¡Œæª” (.bat)
            </button>
        </div>
    </div>
</div>

<div id="tourOverlay" class="tour-overlay">
    <div class="welcome-box">
        <h1 style="margin-top:0;">ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h1>
        <p style="color:#666; margin-bottom:30px;">é€™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡ä½¿ç”¨å—ï¼Ÿæˆ‘å€‘å¯ä»¥èŠ± 30 ç§’å¸¶æ‚¨ç†Ÿæ‚‰æ“ä½œï¼Œç¢ºä¿ç…§ç‰‡åˆ†é¡è¬ç„¡ä¸€å¤±ã€‚</p>
        
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="skip-btn" onclick="skipTour()">æˆ‘æ˜¯è€æ‰‹ï¼Œè·³éæ•™å­¸</button>
            <button class="start-btn" onclick="startTour()">ğŸš€ é–‹å§‹æ–°æ‰‹å°å¼•</button>
        </div>
    </div>
</div>

<div id="tourTooltip" class="tour-tooltip" style="display:none;">
    <span class="tour-step-badge" id="tourStepBadge">Step 1</span>
    <div id="tourText" style="margin-top:5px; font-weight:bold;">èªªæ˜æ–‡å­—</div>
    <div id="tourSubText" style="font-size:13px; color:#666; margin-top:5px;">æç¤ºæ–‡å­—</div>
</div>

<div id="helpModal" class="modal-overlay" onclick="closeHelpModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 style="margin:0;">ğŸ“– æ“ä½œèªªæ˜æ›¸</h2>
            <button style="border:none; background:none; font-size:24px; cursor:pointer;" onclick="closeHelpModal()">Ã—</button>
        </div>
        <div class="modal-body">
            
            <div class="help-section">
                <div class="help-title">æ­¥é©Ÿä¸€ï¼šåŸºæœ¬æ“ä½œæµç¨‹</div>
                <ul class="step-list">
                    <li><span class="step-num">1</span> é»æ“Šå³ä¸Šè§’ç¶ è‰²æŒ‰éˆ• <b>ã€ŒğŸ“‚ é¸æ“‡è³‡æ–™å¤¾ã€</b> è¼‰å…¥ç…§ç‰‡ã€‚</li>
                    <li><span class="step-num">2</span> <b>å·¦æ‰‹</b> æ“ä½œéµç›¤ï¼šæŒ‰ <code>1~4</code> é¸æ“‡ä¸»åˆ†é¡ï¼ŒæŒ‰ <code>A~D</code> é¸æ“‡å­æ¨™ç±¤ã€‚</li>
                    <li><span class="step-num">3</span> <b>å³æ‰‹</b> æ“ä½œéµç›¤ï¼šæŒ‰ <code>Enter</code> åˆ‡æ›ä¸‹ä¸€å¼µã€‚</li>
                    <li><span class="step-num">4</span> é‡åˆ°æ¨¡ç³Š/é‡è¤‡ç…§ç‰‡ï¼ŒæŒ‰ <code>Delete</code> ç›´æ¥ä¸Ÿå…¥å›æ”¶æ¡¶ã€‚</li>
                </ul>
            </div>

            <div class="help-section">
                <div class="help-title">æ­¥é©ŸäºŒï¼šä¸‹è¼‰èˆ‡åŸ·è¡Œ (é‡è¦ï¼)</div>
                <p>æ•´ç†å®Œæˆå¾Œï¼Œé»æ“Šä¸‹æ–¹æ©˜è‰²æŒ‰éˆ•ä¸‹è¼‰ <code>.bat</code> æª”ï¼Œä¸¦å°‡å…¶<b>æ”¾å…¥ç…§ç‰‡è³‡æ–™å¤¾å…§åŸ·è¡Œ</b>ã€‚</p>
                
                <div style="background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba;">
                    <strong style="color:#856404;">âš ï¸ å¸¸è¦‹å•é¡Œï¼šç„¡æ³•é–‹å•Ÿæª”æ¡ˆï¼Ÿ</strong>
                    <p style="margin:5px 0 10px 0; font-size:14px;">å¦‚æœæ‚¨çœ‹åˆ°ä¸‹æ–¹çš„ Windows è­¦å‘Šè¦–çª—ï¼Œé€™æ˜¯æ­£å¸¸çš„è³‡å®‰ä¿è­·æ©Ÿåˆ¶ã€‚</p>
                    
                    <div class="win-alert">
                        <div class="win-title">Windows å®‰å…¨æ€§</div>
                        <div class="win-bar">
                            <div class="win-icon">!</div>
                            <div class="win-text">ç„¡æ³•é–‹å•Ÿé€™äº›æª”æ¡ˆ</div>
                        </div>
                        <div class="win-body">
                            ç¶²éš›ç¶²è·¯å®‰å…¨æ€§è¨­å®šå°è‡´ç„¡æ³•é–‹å•Ÿä¸€æˆ–å¤šå€‹æª”æ¡ˆã€‚<br>
                            <span style="background:#f0f0f0; font-family:monospace;">C:\Users\...\é–‹å§‹æ•´ç†.bat</span>
                        </div>
                    </div>

                    <p><b>âœ… è§£æ±ºæ–¹æ³•ï¼š</b></p>
                    <ol style="font-size:14px;">
                        <li>å°è‘— <code>.bat</code> æª”æŒ‰ <b>æ»‘é¼ å³éµ</b>ã€‚</li>
                        <li>é¸æ“‡ <b>ã€Œå…§å®¹ (Properties)ã€</b>ã€‚</li>
                        <li>å‹¾é¸æœ€ä¸‹æ–¹çš„ <b>ã€Œè§£é™¤é–å®š (Unblock)ã€</b>ï¼Œç„¶å¾ŒæŒ‰ç¢ºå®šã€‚</li>
                    </ol>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- è³‡æ–™çµæ§‹ ---
    let categories = [ { name: "æ´»å‹•", key: "1" }, { name: "æœƒè­°", key: "2" }, { name: "å ´å‹˜", key: "3" }, { name: "å…¶ä»–", key: "4" } ];
    let tags = [ { name: "é•·å®˜", key: "A" }, { name: "å¤§åˆç…§", key: "S" }, { name: "ç‰¹å¯«", key: "D" } ];
    
    let isDemoMode = true; // é è¨­ç‚ºæ•™å­¸æ¨¡å¼
    let demoData = { category: null, tags: new Set(), isDeleted: false };
    let files = [], fileData = [], currentIndex = 0;
    let keyMap = {}; 
    let rotationDeg = 0;

    // --- DOM ---
    const UI = {
        img: document.getElementById('currentImage'),
        catContainer: document.getElementById('catContainer'),
        tagContainer: document.getElementById('tagContainer'),
        preview: document.getElementById('finalPreview'),
        uploadBtn: document.getElementById('uploadBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        trashOverlay: document.getElementById('trashOverlay'),
        tourOverlay: document.getElementById('tourOverlay'),
        tourTooltip: document.getElementById('tourTooltip'),
        helpModal: document.getElementById('helpModal')
    };

    // --- åˆå§‹åŒ– ---
    initButtons();
    updateKeyMap();

    function initButtons() {
        UI.catContainer.innerHTML = '';
        categories.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            btn.id = `cat_${c.key}`;
            btn.dataset.val = c.name;
            btn.innerHTML = `${c.name} <span class="key-badge">${c.key}</span>`;
            btn.onclick = () => selectCategory(c.name);
            UI.catContainer.appendChild(btn);
        });

        UI.tagContainer.innerHTML = '';
        tags.forEach(t => {
            const btn = document.createElement('div');
            btn.className = 'tag-btn';
            btn.id = `tag_${t.key}`;
            btn.dataset.val = t.name;
            btn.innerHTML = `${t.name} <span class="key-badge">${t.key}</span>`;
            btn.onclick = () => toggleTag(t.name);
            UI.tagContainer.appendChild(btn);
        });
    }

    function updateKeyMap() {
        keyMap = {};
        categories.forEach(c => keyMap[c.key.toLowerCase()] = { type: 'cat', val: c.name });
        tags.forEach(t => keyMap[t.key.toLowerCase()] = { type: 'tag', val: t.name });
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function getData() { return isDemoMode ? demoData : fileData[currentIndex]; }

    function selectCategory(name) {
        let data = getData();
        if(data.isDeleted) { data.isDeleted = false; UI.trashOverlay.style.display = 'none'; }
        data.category = name;
        updateUI();
        if(tourStep === 1 && name === 'æ´»å‹•') nextTourStep();
    }

    function toggleTag(name) {
        let data = getData();
        if (data.tags.has(name)) data.tags.delete(name); else data.tags.add(name);
        updateUI();
        if(tourStep === 2 && data.tags.has('é•·å®˜')) nextTourStep();
    }

    function markDeleted() {
        let data = getData();
        data.isDeleted = !data.isDeleted;
        updateUI();
        if(tourStep === 3 && data.isDeleted) nextTourStep();
    }
    
    function rotateImage() {
        rotationDeg = (rotationDeg + 90) % 360;
        UI.img.style.transform = `rotate(${rotationDeg}deg)`;
    }

    function updateUI() {
        let data = getData();
        UI.trashOverlay.style.display = data.isDeleted ? 'flex' : 'none';
        
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', !data.isDeleted && b.dataset.val === data.category));
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.toggle('active', data.tags.has(b.dataset.val)));

        if (data.isDeleted) {
            UI.preview.textContent = "ğŸ—‘ï¸ å°‡ç§»è‡³å›æ”¶æ¡¶";
            UI.preview.style.color = "#dc3545";
        } else if (!data.category) {
            UI.preview.textContent = "è«‹é¸æ“‡ä¸»åˆ†é¡...";
            UI.preview.style.color = "#666";
        } else {
            let parts = [data.category];
            tags.forEach(t => { if(data.tags.has(t.name)) parts.push(t.name); });
            UI.preview.textContent = `å­˜æª”ç‚º: ${data.category}\\${parts.join('_')}_001.jpg`;
            UI.preview.style.color = "#333";
        }
    }

    // --- éµç›¤ç›£è½ ---
    document.addEventListener('keydown', (e) => {
        // Modal é–‹å•Ÿæ™‚ä¸è§¸ç™¼
        if (UI.tourOverlay.style.display !== 'none' && !isDemoMode) return;
        if (UI.helpModal.style.display === 'flex') return;

        const key = e.key.toLowerCase();
        if (key === 'delete') markDeleted();
        else if (key === 'r') rotateImage();
        else if (key === 'enter' && !isDemoMode) nextImage();
        else if (key === 'arrowleft' && !isDemoMode) prevImage();
        else if (key === 'arrowright' && !isDemoMode) nextImage();
        else if (keyMap[key]) {
            const act = keyMap[key];
            if (act.type === 'cat') selectCategory(act.val);
            if (act.type === 'tag') toggleTag(act.val);
            
            // è¦–è¦ºå›é¥‹
            const btn = document.getElementById(`${act.type}_${key.toUpperCase()}`);
            if(btn) {
                btn.style.transform = "scale(0.95)";
                setTimeout(()=>btn.style.transform="scale(1)", 100);
            }
        }
    });

    // --- å°è¦½æµç¨‹ ---
    let tourStep = 0;

    function skipTour() {
        UI.tourOverlay.style.display = 'none';
        endDemoMode();
    }

    function startTour() {
        document.querySelector('.welcome-box').style.display = 'none';
        tourStep = 1;
        showStep(1);
    }

    function showStep(step) {
        // æ¸…é™¤èˆŠ Spotlight
        document.querySelectorAll('.spotlight').forEach(el => {
            el.classList.remove('spotlight');
            el.classList.remove('allow-click');
        });

        const tooltip = UI.tourTooltip;
        tooltip.style.display = 'block';

        if(step === 1) {
            document.getElementById('tourStepBadge').textContent = "Step 1";
            document.getElementById('tourText').textContent = "é¸æ“‡ä¸»åˆ†é¡";
            document.getElementById('tourSubText').textContent = "è«‹æŒ‰éµç›¤ '1' é¸æ“‡æ´»å‹•";
            highlightElement('cat_1', tooltip, 'right');
        } else if (step === 2) {
            document.getElementById('tourStepBadge').textContent = "Step 2";
            document.getElementById('tourText').textContent = "åŠ ä¸Šæ¨™ç±¤";
            document.getElementById('tourSubText').textContent = "è«‹æŒ‰éµç›¤ 'A' åŠ ä¸Šé•·å®˜";
            highlightElement('tag_A', tooltip, 'right');
        } else if (step === 3) {
            document.getElementById('tourStepBadge').textContent = "Step 3";
            document.getElementById('tourText').textContent = "åˆªé™¤å»¢ç‰‡";
            document.getElementById('tourSubText').textContent = "æŒ‰ 'Delete' éµä¸Ÿæ£„ç…§ç‰‡";
            highlightElement('imgPanel', tooltip, 'center');
        } else if (step === 4) {
            tooltip.style.display = 'none';
            alert("ğŸ‰ ç·´ç¿’çµæŸï¼ç¾åœ¨æ‚¨å·²è§£é–æ‰€æœ‰åŠŸèƒ½ã€‚");
            UI.tourOverlay.style.display = 'none';
            endDemoMode();
        }
    }

    function nextTourStep() {
        setTimeout(() => { tourStep++; showStep(tourStep); }, 400);
    }

    function highlightElement(id, tooltip, pos) {
        const el = document.getElementById(id);
        el.classList.add('spotlight');
        el.classList.add('allow-click');
        
        const rect = el.getBoundingClientRect();
        if (pos === 'right') {
            tooltip.style.top = rect.top + "px";
            tooltip.style.left = (rect.left - 300) + "px";
        } else {
            tooltip.style.top = (rect.bottom + 20) + "px";
            tooltip.style.left = (window.innerWidth/2 - 140) + "px";
        }
    }

    function endDemoMode() {
        isDemoMode = false;
        demoData = { category: null, tags: new Set(), isDeleted: false };
        updateUI();
        UI.uploadBtn.classList.add('active'); // è§£é–ä¸Šå‚³æŒ‰éˆ•
        UI.downloadBtn.classList.add('active'); // è§£é–ä¸‹è¼‰æŒ‰éˆ•
        document.getElementById('currentImage').src = "";
    }

    // --- æ•™å­¸ Modal ---
    function openHelpModal() { UI.helpModal.style.display = 'flex'; }
    function closeHelpModal() { UI.helpModal.style.display = 'none'; }

    // --- çœŸå¯¦æª”æ¡ˆè™•ç† ---
    document.getElementById('folderInput').addEventListener('change', function(e) {
        if(isDemoMode) return;
        files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
        if (!files.length) { alert("æ²’æœ‰åœ–ç‰‡ï¼"); return; }
        
        fileData = files.map(f => ({ originalName: f.name, category: null, tags: new Set(), isDeleted: false }));
        const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
        files.sort((a, b) => collator.compare(a.name, b.name));
        fileData.sort((a, b) => collator.compare(a.originalName, b.originalName));

        currentIndex = 0;
        loadRealImage();
    });

    function loadRealImage() {
        if (!files.length) return;
        const img = document.getElementById('currentImage');
        if (img.src) URL.revokeObjectURL(img.src);
        img.src = URL.createObjectURL(files[currentIndex]);
        img.style.transform = "rotate(0deg)"; rotationDeg = 0; // é‡ç½®æ—‹è½‰
        updateUI();
    }

    function nextImage() {
        // å¼·åˆ¶æª¢æŸ¥ï¼šæœªåˆ†é¡ä¸èƒ½ä¸‹ä¸€å¼µ (é™¤éåˆªé™¤)
        if (!fileData[currentIndex].isDeleted && !fileData[currentIndex].category) {
            document.getElementById('catContainer').style.animation = "shake 0.3s";
            setTimeout(() => document.getElementById('catContainer').style.animation = "", 300);
            return;
        }

        if(currentIndex < files.length - 1) { currentIndex++; loadRealImage(); }
        else alert("ğŸ‰ å…¨éƒ¨å®Œæˆï¼");
    }

    function prevImage() {
        if(currentIndex > 0) { currentIndex--; loadRealImage(); }
    }

    // --- åŒ¯å‡º BAT (æ ¸å¿ƒåŠŸèƒ½) ---
    function exportBat() {
        if(isDemoMode) { alert("è«‹å…ˆé¸æ“‡è³‡æ–™å¤¾è¼‰å…¥çœŸå¯¦ç…§ç‰‡ï¼"); return; }
        if(!files.length) return;

        let batContent = "@echo off\r\nchcp 65001 >nul\r\necho æ­£åœ¨æ•´ç†ç…§ç‰‡...\r\n\r\n";
        
        // 1. å»ºç«‹è³‡æ–™å¤¾
        let folders = new Set();
        folders.add("_TRASH");
        fileData.forEach(d => { if(d.category && !d.isDeleted) folders.add(d.category); });
        folders.forEach(f => { batContent += `if not exist "${f}" md "${f}"\r\n`; });
        batContent += "\r\n";

        // 2. è™•ç†æª”æ¡ˆ
        let catCounts = {}; 

        fileData.forEach(item => {
            if (item.isDeleted) {
                batContent += `move "${item.originalName}" "_TRASH\\${item.originalName}"\r\n`;
                return;
            }
            if (!item.category) return;

            // è¨ˆç®—æµæ°´è™Ÿ
            if (!catCounts[item.category]) catCounts[item.category] = 0;
            catCounts[item.category]++;
            let seq = String(catCounts[item.category]).padStart(3, '0');

            // çµ„åˆæª”å
            let parts = [item.category];
            tags.forEach(t => { if(item.tags.has(t.name)) parts.push(t.name); });
            
            let ext = item.originalName.split('.').pop();
            let newName = `${parts.join('_')}_${seq}.${ext}`;

            batContent += `move "${item.originalName}" "${item.category}\\${newName}"\r\n`;
        });

        batContent += `\r\necho æ•´ç†å®Œæˆï¼\r\npause`;

        const blob = new Blob([batContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "é–‹å§‹æ•´ç†.bat";
        link.click();
    }

</script>
<style>
@keyframes shake { 0% {transform: translateX(0);} 25% {transform: translateX(-5px);} 50% {transform: translateX(5px);} 75% {transform: translateX(-5px);} 100% {transform: translateX(0);} }
</style>
</body>
</html>
