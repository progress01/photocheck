<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ­¸æª”å·¥å…·V8.11</title>
    <style>
        :root { --primary: #0d6efd; --purple: #6610f2; --success: #198754; --warning: #ffc107; --danger: #dc3545; --bg: #f8f9fa; --overlay-bg: rgba(0,0,0,0.85); }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å°èˆªåˆ— */
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 50; }
        .nav-title { margin: 0; font-size: 1.2rem; font-weight: bold; }

        /* --- æ–°å¢ï¼šä¸Šæ–¹ä¸­é–“çš„ç‹€æ…‹åˆ—æ¨£å¼ --- */
        .nav-center-stats {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 50px;
            border: 1px solid #e9ecef;
            font-size: 14px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .stat-origin { color: #888; text-decoration: line-through; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.9em; }
        .stat-arrow { margin: 0 10px; color: #ccc; font-weight: bold; }
        .stat-target { 
            color: #0d6efd; 
            font-weight: bold; 
            font-size: 1.1em; 
            font-family: Consolas, monospace;
            background: #e7f1ff;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .main-layout { display: grid; grid-template-columns: 1fr 420px; gap: 20px; flex: 1; min-height: 0; position: relative; }
        
        /* åœ–ç‰‡å€ */
        .image-panel { background: #222; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* åœ–ç‰‡å®¹å™¨èˆ‡æ¨¡å¼ */
        .image-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .image-container img { transition: transform 0.2s ease; display: none; transform-origin: center center; }
        
        /* é¡¯ç¤ºæ¨¡å¼ (CSS Class) */
        .view-fit img { max-width: 95%; max-height: 95%; object-fit: contain; }
        .view-fill img { width: 100%; height: 100%; object-fit: cover; }
        .view-small img { max-width: 60%; max-height: 60%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* è¦–åœ–åˆ‡æ›æŒ‰éˆ• */
        .view-controls { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 30; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 20px; backdrop-filter: blur(4px); }
        .view-btn { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 12px; font-size: 12px; cursor: pointer; border-radius: 15px; transition: 0.2s; }
        .view-btn:hover { background: rgba(255,255,255,0.2); }
        .view-btn.active { background: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* è³‡è¨Šå„€è¡¨æ¿ */
        .info-bar { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.7); color: white; 
            padding: 8px 15px; box-sizing: border-box; 
            display: flex; justify-content: space-between; font-size: 14px; font-family: monospace;
            backdrop-filter: blur(2px); z-index: 20;
        }

        /* é è¨­ä½”ä½ */
        .placeholder-content { text-align: center; color: #666; }
        .placeholder-icon { font-size: 5rem; margin-bottom: 10px; opacity: 0.3; }
        
        /* ç‹€æ…‹é®ç½© */
        .status-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; color: #ff6b6b; font-size: 4rem; font-weight: bold; z-index: 10; flex-direction: column; pointer-events: none; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { background: white; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-header { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* å·¥å…·åˆ— */
        .toolbar { display: flex; gap: 8px; margin-bottom: 5px; }
        .tool-btn { flex: 1; padding: 8px; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .tool-btn:hover { background: #f0f0f0; }
        .tool-btn.active { background: #e7f5ff; border-color: var(--primary); color: var(--primary); font-weight: bold; }

        /* åˆ†é¡æŒ‰éˆ• */
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        
        /* --- æ–°å¢ä¿®æ­£ï¼šé™åˆ¶åˆ†é¡èˆ‡æ¨™ç±¤çš„é«˜åº¦ï¼Œè¶…éæ™‚å‡ºç¾æ»¾å‹•æ¢ --- */
        #catContainer, #tagContainer {
            max-height: 25vh;  /* è¨­å®šæœ€å¤§é«˜åº¦ */
            overflow-y: auto;  /* å…§å®¹è¶…éæ™‚é¡¯ç¤ºå‚ç›´æ²è»¸ */
            padding-right: 5px; 
            border: 1px solid #f8f9fa;
            border-radius: 6px;
            align-content: start;
        }
        #catContainer::-webkit-scrollbar, #tagContainer::-webkit-scrollbar { width: 6px; }
        #catContainer::-webkit-scrollbar-thumb, #tagContainer::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }

        .cat-btn, .tag-btn { 
            background: white; border: 1px solid #ccc; padding: 10px 5px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; text-align: center; transition: 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 45px; user-select: none;
        }
        .cat-btn:hover, .tag-btn:hover { background: #f8f9fa; border-color: #999; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; transform: scale(0.98); box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3); }
        .tag-btn.active { background: var(--purple); color: white; border-color: var(--purple); font-weight: bold; transform: scale(0.98); box-shadow: 0 2px 5px rgba(102, 16, 242, 0.3); }
        .key-badge { position: absolute; top: 2px; right: 2px; background: #333; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; opacity: 0.8; font-family: monospace; }
        .cat-btn.active .key-badge, .tag-btn.active .key-badge { background: white; color: #333; }

        /* å‘½åæ§åˆ¶å€ */
        .naming-control { border: 2px solid #eee; padding: 15px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; cursor: pointer; user-select: none; }
        
        /* é–‹é—œæ¨£å¼ */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }
        
        .input-wrapper { position: relative; }
        .custom-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; background: #fff; transition:0.3s; }
        .custom-input:disabled { background: #e9ecef; color: #aaa; cursor: not-allowed; border-color: #eee; }
        .custom-input:focus { border-color: var(--primary); outline: none; }
        .num-input { width:80px; padding:5px; text-align:center; border:1px solid #ccc; border-radius:4px; margin-left:10px; }

        /* é è¦½èˆ‡å°èˆªå€ */
        .preview-box { background: #e9ecef; padding: 12px; border-radius: 6px; text-align: right; font-family: monospace; font-size: 0.95rem; color: #555; margin-top: auto; border: 1px solid #dee2e6; }
        
        /* å°èˆªæŒ‰éˆ• */
        .nav-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .nav-btn { flex: 1; padding: 12px; font-size: 15px; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn-primary { flex: 1.5; background: var(--primary); color: white; border: none; }
        .nav-btn-primary:hover { background: #0b5ed7; }

        /* ä¸‹è¼‰æŒ‰éˆ•ç¾¤ */
        .btn-download { background: #fd7e14; color: white; width: 100%; padding: 15px; font-size: 15px; border: none; border-radius: 6px; cursor: not-allowed; font-weight: bold; opacity: 0.5; transition:0.3s; pointer-events: none; margin-top: 5px; }
        .btn-download.active { cursor: pointer; opacity: 1; pointer-events: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-download.active:hover { transform: translateY(-2px); }
        #reportBtn.active:hover { background: #146c43; }
        #downloadBtn.active:hover { background: #e96b02; }

        /* ä¸Šæ–¹æŒ‰éˆ• */
        .btn-help { background: var(--purple); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-upload { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 15px; transition:0.2s; }
        .btn-upload:hover { background: #157347; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        /* æ­¡è¿èˆ‡å°è¦½ */
        .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .welcome-box { background: white; color: #333; padding: 40px; border-radius: 12px; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .start-btn { padding: 12px 30px; font-size: 1.1rem; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin: 10px; }
        .skip-btn { background: transparent; color: #666; border: 1px solid #ccc; padding: 10px 20px; border-radius: 50px; cursor: pointer; margin: 10px; }
        
        .spotlight { position: relative; z-index: 10000; box-shadow: 0 0 0 9999px var(--overlay-bg); background: white; pointer-events: none; border-radius: 6px; }
        .allow-click { pointer-events: auto !important; cursor: pointer; }
        .tour-tooltip { position: fixed; background: white; color: #333; padding: 20px; border-radius: 10px; width: 300px; z-index: 10003; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }
        .tour-actions { display: flex; justify-content: flex-end; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .tour-skip-step { font-size: 12px; color: #999; background: none; border: none; cursor: pointer; text-decoration: underline; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 850px; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; cursor: pointer; font-weight: bold; color: #666; text-align: center; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; display: none; }
        .modal-body.active { display: block; }

        /* è¨­å®šè¡¨æ ¼ */
        /* --- â­ ä¿®æ”¹ï¼šè®“è¨­å®šå€å¡Šè‡ªå‹•å¡«æ»¿ä¸¦ç¨ç«‹æ»¾å‹• --- */
        .settings-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            
            flex: 1;              /* é—œéµï¼šè‡ªå‹•ä½”æ»¿å‰©é¤˜é«˜åº¦ */
            overflow-y: auto;     /* é—œéµï¼šå…§å®¹å¤ªé•·æ™‚é¡¯ç¤ºæ»¾å‹•æ¢ */
            min-height: 0;        /* é¿å…è¢«å…§å®¹æ’é–‹å®¹å™¨ */
            align-content: start; /* å…§å®¹å°‘æ™‚é ä¸Šå°é½Š */
            padding-right: 5px;   /* é ç•™ä¸€é»å³é‚Šè·çµ¦æ²è»¸ */
            margin-bottom: 10px;  /* èˆ‡ä¸‹æ–¹æŒ‰éˆ•ä¿æŒè·é›¢ */
        }
        .settings-grid::-webkit-scrollbar { width: 6px; }
        .settings-grid::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
        
        .settings-col h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #555; }
        .settings-table { width: 100%; border-collapse: collapse; }
        .settings-table td { padding: 8px 0; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .settings-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .key-input { width: 60px; text-align: center; text-transform: uppercase; font-weight: bold; }
        .add-btn { width: 100%; padding: 10px; margin-top: 10px; background: #f8f9fa; border: 1px dashed #ccc; cursor: pointer; border-radius: 4px; transition: 0.2s; }
        .add-btn:hover { background: #e9ecef; }
        .save-btn { background: var(--primary); color: white; padding: 10px; border: none; border-radius: 6px; width: 100%; margin-top: 15px; font-weight: bold; cursor: pointer; }
        
        .icon-btn { 
            width: 32px; height: 32px; border-radius: 50%; border: none; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.2s; font-weight: bold; font-size: 16px;
        }
        .btn-del { background: #fee2e2; color: #dc3545; margin-left: auto; }
        .btn-del:hover { background: #dc3545; color: white; }

        .bat-diagram { display: flex; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; text-align: center; font-size: 13px; }
        .bat-step { flex: 1; } .bat-icon { font-size: 1.8rem; display: block; }
        .win-alert { border: 1px solid #d9d9d9; background: white; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-family: "Segoe UI", sans-serif; }
        .win-bar { background: #ffcc00; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .win-body { padding: 15px; font-size: 13px; color: #333; }
        
        .important-box { background:#fff3cd; border-left:5px solid #ffc107; padding:15px; margin-bottom:15px; }
        .help-block { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .help-block:last-child { border-bottom: none; }
        .help-step-title { font-weight: bold; color: var(--primary); font-size: 1.1em; margin-bottom: 8px; display: block; }

        /* --- æ–°å¢ï¼šæ­·å²ç´€éŒ„å´é‚ŠæŠ½å±œ --- */
        .history-drawer {
            position: fixed;
            top: 0;
            right: -320px; /* é è¨­è—åœ¨å³é‚Šå¤–é¢ */
            width: 300px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            z-index: 2000;
            transition: right 0.3s ease; /* æ»‘å‹•ç‰¹æ•ˆ */
            display: flex;
            flex-direction: column;
        }
        .history-drawer.active { right: 0; }
        .history-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-body { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* æ­·å²æ¸…å–®é …ç›®çš„æ¨£å¼ */
        .history-item {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item:last-child { border-bottom: none; }
        .history-item.current { background: #e7f1ff; border-left: 3px solid #0d6efd; }
        .history-seq { color: #0d6efd; font-weight: bold; font-family: monospace; }
        .history-trash { color: #dc3545; text-decoration: line-through; color:#aaa; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-title">ğŸ“· ç…§ç‰‡æ­¸æª”å·¥å…· <span style="font-size:0.8em; font-weight:normal;">v8.11</span></div>
    
    <div class="nav-center-stats" id="navStats" style="display:none;">
        <span class="stat-origin" id="navOriginName">åŸå§‹æª”å</span>
        <span class="stat-arrow">â”</span>
        <span class="stat-target" id="navTargetName">...</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
        <button class="tool-btn" onclick="toggleHistory()">ğŸ“ æ­·å²ç´€éŒ„</button>
        <button class="tool-btn" onclick="rotateImage()">âŸ³ è½‰å‘ (åƒ…é è¦½)</button>
        <button class="btn-help" onclick="openHelpModal('tab1')">â“ æ•™å­¸</button>
        <label for="folderInput" id="uploadBtn" class="btn-upload" onclick="return checkUpload()"><span>ğŸ“‚ é¸æ“‡è³‡æ–™å¤¾</span></label>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
    </div>
</div>

<div class="main-layout">
    <div class="image-panel" id="imgPanel">
        <div class="view-controls" id="viewControls">
            <button class="view-btn active" onclick="changeView('fit')">å®Œæ•´ (Fit)</button>
            <button class="view-btn" onclick="changeView('small')">å°åœ– (Focus)</button>
        </div>

        <div class="image-container view-fit" id="imgContainer">
            <img id="currentImage" src="" alt="">
        </div>
        
        <div class="info-bar" id="infoBar" style="display:none;">
            <div id="infoFilename">ç­‰å¾…è¼‰å…¥...</div>
            <div id="infoProgress">0 / 0</div>
        </div>

        <div id="placeholder" class="placeholder-content">
            <div class="placeholder-icon">ğŸ“‚</div>
            <h3>ç­‰å¾…è¼‰å…¥ç…§ç‰‡</h3>
            <p>è«‹é»æ“Šå³ä¸Šè§’ã€Œé¸æ“‡è³‡æ–™å¤¾ã€é–‹å§‹</p>
        </div>
        <div class="status-overlay" id="trashOverlay"><div>ğŸ—‘ï¸</div><div style="font-size:1.5rem; color:white;">å·²ä¸Ÿå…¥å›æ”¶æ¡¶</div></div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="toolbar">
            <button class="tool-btn" onclick="openSettings()">âš™ï¸ è¨­å®šåˆ†é¡</button>
            <button class="tool-btn" id="lockBtn" onclick="toggleLock()">ğŸ”“ é–å®šåˆ†é¡</button>
        </div>

        <div id="catSection">
            <div class="section-header">ğŸ“‚ ä¸»åˆ†é¡ (è³‡æ–™å¤¾)</div>
            <div id="catContainer" class="btn-grid"></div>
        </div>

        <div id="tagSection">
            <div class="section-header">ğŸ·ï¸ å­æ¨™ç±¤ (å¾Œç¶´)</div>
            <div id="tagContainer" class="btn-grid"></div>
        </div>

        <div class="naming-control" id="namingSection">
            <div class="section-header" style="border:none; margin-bottom:5px;">
                âœï¸ å‘½åè¦å‰‡ (å¯è‡ªè¨‚)
                <span style="font-size:0.8em; font-weight:normal; color:#888; margin-left:5px;">æŒ‰ F2 å¿«é€Ÿåˆ‡æ›</span>
            </div>
            <div class="toggle-row">
                <span style="font-size:14px; font-weight:bold; color:#555;">è‡ªå‹•æµæ°´è™Ÿ (_001)</span>
                <label class="switch">
                    <input type="checkbox" id="autoSeqCheck" checked onchange="toggleNamingMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="input-wrapper" style="display:flex; align-items:center;">
                <input type="text" id="customInput" class="custom-input" placeholder="è¼¸å…¥è‡ªè¨‚æª”å... (F2)" disabled oninput="onCustomInputChange(this)">
            </div>
            <div class="input-wrapper" style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; font-size:14px; color:#555;">
                <span>ğŸ”¢ æµæ°´è™Ÿèµ·å§‹å€¼ï¼š</span>
                <input type="number" id="startSeqInput" class="num-input" value="1" min="1" onchange="updateUI()">
            </div>
            <div style="font-size:12px; color:#888; margin-top:5px;">* åˆ†æ‰¹è™•ç†æ™‚è«‹ä¿®æ”¹æ­¤æ•¸å€¼ (ä¾‹: 101) ä»¥å…æª”åè¡çª</div>
        </div>

        <div style="margin-top:auto;">
            <div class="preview-box" id="finalPreview">ç­‰å¾…æ“ä½œ...</div>
            
            <div class="nav-btn-group">
                <button class="nav-btn" onclick="prevImage()">â† ä¸Šä¸€å¼µ</button>
                <button class="nav-btn nav-btn-primary" onclick="nextImage()">ä¸‹ä¸€å¼µ (Enter)</button>
            </div>

            <div style="margin-top:10px;">
                <button id="reportBtn" class="btn-download" style="background:#198754;" onclick="exportReport()">ğŸ“„ ä¸‹è¼‰æª”æ¡ˆåƒç…§è¡¨ (.html)</button>
                <button id="downloadBtn" class="btn-download" onclick="exportBat()">âš¡ ä¸‹è¼‰æ•´ç†åŸ·è¡Œæª” (.bat)</button>
            </div>
        </div>
    </div>
</div>

<div id="historyPanel" class="history-drawer">
    <div class="history-header">
        <span>ğŸ“œ å·²å‘½åæª”æ¡ˆæ¸…å–®</span>
        <button onclick="toggleHistory()" style="border:none; background:none; cursor:pointer; font-size:18px;">Ã—</button>
    </div>
    <div id="historyList" class="history-body">
        </div>
</div>

<div id="welcomeOverlay" class="tour-overlay">
    <div class="welcome-box">
        <h1>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h1>
        <p style="color:#666; margin-bottom:30px;">ç¬¬ä¸€æ¬¡ä½¿ç”¨å—ï¼Ÿå»ºè­°èŠ± 30 ç§’å®Œæˆæ–°æ‰‹å¼•å°ï¼Œç¢ºä¿æ“ä½œç„¡èª¤ã€‚</p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="skip-btn" onclick="skipTour()">è·³éæ•™å­¸</button>
            <button class="start-btn" onclick="startTour()">ğŸš€ é–‹å§‹æ–°æ‰‹å°å¼•</button>
        </div>
    </div>
</div>

<div id="tourTooltip" class="tour-tooltip">
    <span style="background:#0d6efd; color:white; padding:2px 8px; border-radius:10px; font-size:12px;">Step <span id="tourStepBadge">1</span></span>
    <div id="tourText" style="margin-top:5px; font-weight:bold;">æ¨™é¡Œ</div>
    <div id="tourSubText" style="font-size:13px; color:#666; margin-top:5px;">èªªæ˜</div>
    <div class="tour-actions"><button class="tour-skip-step" onclick="forceNextStep()">è·³éé€™ä¸€æ­¥ â”</button></div>
</div>

<div id="dimmer" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; display:none;"></div>

<div id="helpModal" class="modal-overlay" onclick="closeHelpModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-tabs">
            <div class="tab-btn active" onclick="switchTab('tab1')" id="btn-tab1">ğŸ“– æ“ä½œæµç¨‹</div>
            <div class="tab-btn" onclick="switchTab('tab2')" id="btn-tab2">ğŸ§ª åŸç†èˆ‡ä½ç½®</div>
            <button style="margin-left:auto; border:none; background:none; font-size:24px; cursor:pointer; padding:0 20px;" onclick="closeHelpModal()">Ã—</button>
        </div>
        <div id="tab1" class="modal-body active">
            <div class="important-box">
                <strong>âš ï¸ é‡è¦ç¬¬ä¸€æ­¥ï¼š</strong><br>
                è«‹ç¢ºä¿é€™å€‹ <code>.html</code> å·¥å…·æª”æ¡ˆï¼Œæ˜¯æ”¾åœ¨æ‚¨ <b>ã€Œç…§ç‰‡è³‡æ–™å¤¾çš„æœ€å¤–å±¤ã€</b>ã€‚<br>
                ä¸è¦æ”¾åœ¨å­è³‡æ–™å¤¾ä¸­åŸ·è¡Œã€‚
            </div>
            
            <div class="help-section">
                <div class="help-block">
                    <span class="help-step-title">1ï¸âƒ£ åŸºç¤æµç¨‹ (SOP)</span>
                    <ul style="line-height:1.8; margin-top:5px;">
                        <li><b>æ•´ç†ï¼š</b>é»æ“Šå³ä¸Šè§’ã€ŒğŸ“‚ é¸æ“‡è³‡æ–™å¤¾ã€è®€å–ç…§ç‰‡ã€‚</li>
                        <li><b>æ­¸æª”ï¼š</b>ä½¿ç”¨éµç›¤æŒ‰éµ (å¦‚ 1, 2) å¿«é€Ÿåˆ†é¡ç…§ç‰‡ã€‚</li>
                        <li><b>åˆªé™¤ï¼š</b>æŒ‰ <b>Delete</b> éµå°‡ç…§ç‰‡æ¨™è¨˜ç‚ºåˆªé™¤ (æœƒç§»è‡³ _TRASH è³‡æ–™å¤¾)ã€‚</li>
                        <li><b>åŸ·è¡Œï¼š</b>æ•´ç†å®Œç•¢å¾Œï¼Œä¸‹è¼‰ä¸¦åŸ·è¡Œ <b>.bat</b> æª”å®Œæˆç§»å‹•ã€‚</li>
                    </ul>
                </div>

                <div class="help-block">
                    <span class="help-step-title">2ï¸âƒ£ é€²éšï¼šåŸåœ°æ”¹å (ä¸ç§»å‹•)</span>
                    <p style="line-height:1.6; color:#555;">
                        å¦‚æœæ‚¨åªæƒ³ä¿®æ”¹æª”åï¼Œè€Œä¸æƒ³æŠŠç…§ç‰‡ç§»å‹•åˆ°åˆ†é¡è³‡æ–™å¤¾ä¸­ï¼š<br>
                        ğŸ‘‰ <b>è«‹ä¸è¦é»é¸ä»»ä½•ã€Œä¸»åˆ†é¡ã€æŒ‰éˆ•ã€‚</b><br>
                        ç³»çµ±æœƒé¡¯ç¤ºé è¦½è·¯å¾‘ç‚º <code>.\æ–°æª”å.jpg</code>ï¼Œä»£è¡¨æª”æ¡ˆæœƒä¿ç•™åœ¨åŸè™•ï¼Œåƒ…ä¿®æ”¹åç¨±ã€‚
                    </p>
                </div>

                <div class="help-block">
                    <span class="help-step-title">3ï¸âƒ£ é€²éšï¼šè‡ªè¨‚æª”å (F2)</span>
                    <ul style="line-height:1.8; margin-top:5px;">
                        <li><b>åˆ‡æ›æ¨¡å¼ï¼š</b>æŒ‰ <b>F2</b> éµæˆ–é»æ“Šã€Œè‡ªå‹•æµæ°´è™Ÿã€é–‹é—œï¼Œåˆ‡æ›è‡³è‡ªè¨‚è¼¸å…¥æ¨¡å¼ã€‚</li>
                        <li><b>æ™ºæ…§å¸¶å…¥ï¼š</b>ç•¶æ‚¨åˆ‡æ›åˆ°ä¸‹ä¸€å¼µæœªåˆ†é¡çš„ç…§ç‰‡æ™‚ï¼Œç³»çµ±æœƒ<b>è‡ªå‹•å¡«å…¥åŸå§‹æª”å</b>åˆ°è¼¸å…¥æ¡†ä¸­ï¼Œæ–¹ä¾¿æ‚¨ç›´æ¥ä¿®æ”¹ (ä¸ç”¨é‡æ‰“)ã€‚</li>
                        <li><b>æ‡‰ç”¨å ´æ™¯ï¼š</b>é©åˆç”¨ä¾†å€‹åˆ¥å‘½åç²¾é¸ç…§ç‰‡ï¼Œä¾‹å¦‚ <code>æœƒè­°è¨˜éŒ„_è€é—†è‡´è©.jpg</code>ã€‚</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="tab2" class="modal-body">
            <div class="help-section">
                <div class="help-title">æª”æ¡ˆä½ç½®ç¤ºæ„åœ–</div>
                <div style="background:#333; color:white; padding:15px; border-radius:6px; font-family:monospace; line-height:1.5;">
                    ğŸ“‚ 2025æ´»å‹•ç…§ç‰‡ (æ‚¨çš„å·¥ä½œå€)<br>
                    â”œâ”€â”€ âš™ï¸ ç…§ç‰‡æ­¸æª”å·¥å…·.html (æœ¬å·¥å…·)<br>
                    â”œâ”€â”€ âš™ï¸ é–‹å§‹æ•´ç†.bat (ç”¢ç”Ÿæª”)<br>
                    â”œâ”€â”€ ğŸ“„ åƒç…§è¡¨.html (ç”¢ç”Ÿæª”)<br>
                    â”œâ”€â”€ ğŸ“‚ æœƒè­°è¨˜éŒ„ (æ­¸æª”å¾Œ)<br>
                    â”œâ”€â”€ ğŸ“‚ ç¾å ´ç…§ç‰‡ (æ­¸æª”å¾Œ)<br>
                    â”œâ”€â”€ ğŸ“„ æ–°æª”å_001.jpg (åŸåœ°æ”¹å)<br>
                    â””â”€â”€ ğŸ“‚ _TRASH (åˆªé™¤çš„ç…§ç‰‡)
                </div>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay" onclick="closeSettings()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button style="align-self:flex-end; border:none; background:none; font-size:24px; cursor:pointer;" onclick="closeSettings()">Ã—</button>
        <h2 style="margin-top:0;">ğŸ› ï¸ è¨­å®šåˆ†é¡èˆ‡æ¨™ç±¤</h2>
        <div class="settings-grid">
            <div class="settings-col">
                <h3>ğŸ“‚ ä¸»åˆ†é¡</h3>
                <table class="settings-table"><tbody id="catSettingsBody"></tbody></table>
                <button class="add-btn" onclick="event.stopPropagation(); addCatRow()">+ æ–°å¢</button>
            </div>
            <div class="settings-col">
                <h3>ğŸ·ï¸ å­æ¨™ç±¤</h3>
                <table class="settings-table"><tbody id="tagSettingsBody"></tbody></table>
                <button class="add-btn" onclick="event.stopPropagation(); addTagRow()">+ æ–°å¢</button>
            </div>
        </div>
        <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>
</div>
<script>
    // --- æ ¸å¿ƒè³‡æ–™ ---
    let categories = [ { name: "ç¯„ä¾‹åˆ†é¡A", key: "1" }, { name: "ç¯„ä¾‹åˆ†é¡B", key: "2" }, { name: "ç¯„ä¾‹åˆ†é¡C", key: "3" }, { name: "å…¶ä»–", key: "4" } ];
    let tags = [ { name: "ç¯„ä¾‹å¾Œç¶´1", key: "A" }, { name: "ç¯„ä¾‹å¾Œç¶´2", key: "S" }, { name: "ç¯„ä¾‹å¾Œç¶´3", key: "D" } ];
    
    let isDemoMode = true; 
    let isTourActive = false;
    let tourStep = 0;
    
    let demoData = { category: null, tags: new Set(), isDeleted: false, customName: "", isAuto: true };
    let files = [], fileData = [], currentIndex = 0;
    let keyMap = {}; 
    let rotationDeg = 0;
    let isLocked = false;
    let currentViewMode = 'fit';
    
    // v8.4: æ™ºæ…§é–‹é—œè¨˜æ†¶è®Šæ•¸ (é è¨­ true)
    let currentAutoState = true;

    // --- DOM ---
    const UI = {
        img: document.getElementById('currentImage'),
        imgContainer: document.getElementById('imgContainer'), 
        infoBar: document.getElementById('infoBar'), 
        infoFilename: document.getElementById('infoFilename'), 
        infoProgress: document.getElementById('infoProgress'), 
        placeholder: document.getElementById('placeholder'),
        catContainer: document.getElementById('catContainer'),
        tagContainer: document.getElementById('tagContainer'),
        preview: document.getElementById('finalPreview'),
        uploadBtn: document.getElementById('uploadBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        reportBtn: document.getElementById('reportBtn'),
        trashOverlay: document.getElementById('trashOverlay'),
        welcomeOverlay: document.getElementById('welcomeOverlay'),
        dimmer: document.getElementById('dimmer'),
        tourTooltip: document.getElementById('tourTooltip'),
        helpModal: document.getElementById('helpModal'),
        settingsModal: document.getElementById('settingsModal'),
        autoSeqCheck: document.getElementById('autoSeqCheck'),
        customInput: document.getElementById('customInput'),
        lockBtn: document.getElementById('lockBtn'),
        startSeqInput: document.getElementById('startSeqInput')
    };

    // --- åˆå§‹åŒ– ---
    initUI();

    function initUI() {
        UI.catContainer.innerHTML = '';
        keyMap = {};
        categories.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            btn.id = `cat_${c.key}`; 
            btn.dataset.val = c.name;
            btn.innerHTML = `${c.name} ${c.key?`<span class="key-badge">${c.key}</span>`:''}`;
            btn.onclick = () => selectCategory(c.name);
            UI.catContainer.appendChild(btn);
            if(c.key) keyMap[c.key.toLowerCase()] = { type: 'cat', val: c.name };
        });

        UI.tagContainer.innerHTML = '';
        tags.forEach(t => {
            const btn = document.createElement('div');
            btn.className = 'tag-btn';
            btn.id = `tag_${t.key}`;
            btn.dataset.val = t.name;
            btn.innerHTML = `${t.name} ${t.key?`<span class="key-badge">${t.key}</span>`:''}`;
            btn.onclick = () => toggleTag(t.name);
            UI.tagContainer.appendChild(btn);
            if(t.key) keyMap[t.key.toLowerCase()] = { type: 'tag', val: t.name };
        });
    }

    // --- ä¸Šå‚³æª¢æŸ¥ ---
    function checkUpload() {
        if (isTourActive) { alert("è«‹å…ˆå®Œæˆæˆ–è·³éæ–°æ‰‹å°å¼•ï¼"); return false; }
        if (isDemoMode) {
            if(confirm("å³å°‡é›¢é–‹æ•™å­¸æ¨¡å¼ï¼Œä¸¦è¼‰å…¥çœŸå¯¦ç…§ç‰‡ã€‚ç¢ºå®šå—ï¼Ÿ")) {
                endDemoMode();
                return true; 
            }
            return false;
        }
        return true;
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function getData() { return isDemoMode ? demoData : fileData[currentIndex]; }

    function selectCategory(name) {
        if (isTourActive && tourStep === 1 && name !== categories[0].name) return; 
        let data = getData();
        if(data.isDeleted) { data.isDeleted = false; }
        data.category = name;
        updateUI();
        if(isTourActive && tourStep === 1 && name === categories[0].name) nextTourStep();
    }

    function toggleTag(name) {
        if (isTourActive && tourStep === 2 && name !== tags[0].name) return;
        let data = getData();
        if (data.tags.has(name)) data.tags.delete(name); else data.tags.add(name);
        updateUI();
        if(isTourActive && tourStep === 2 && data.tags.has(tags[0].name)) nextTourStep();
    }

    function markDeleted() {
        if (isTourActive && tourStep !== 3) return;
        let data = getData();
        data.isDeleted = !data.isDeleted;
        updateUI();
        if(isTourActive && tourStep === 3 && data.isDeleted) nextTourStep();
    }

    function toggleLock() {
        isLocked = !isLocked;
        UI.lockBtn.classList.toggle('active', isLocked);
        UI.lockBtn.innerHTML = isLocked ? "ğŸ”’ å·²é–å®š" : "ğŸ”“ é–å®šåˆ†é¡";
    }

    function rotateImage() {
        rotationDeg = (rotationDeg + 90) % 360;
        UI.img.style.transform = `rotate(${rotationDeg}deg)`;
    }

    // --- è¦–åœ–åˆ‡æ›é‚è¼¯ ---
    function changeView(mode) {
        currentViewMode = mode;
        
        // UIæŒ‰éˆ•ç‹€æ…‹æ›´æ–°
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        if(mode==='fit') document.querySelectorAll('.view-btn')[0].classList.add('active');
        if(mode==='small') document.querySelectorAll('.view-btn')[1].classList.add('active');

        // æ›´æ–°å®¹å™¨ Class
        UI.imgContainer.className = 'image-container'; // reset
        UI.imgContainer.classList.add(`view-${mode}`);
    }

    // --- å‘½åæ§åˆ¶é‚è¼¯ ---
    function toggleNamingMode() {
        let data = getData();
        data.isAuto = UI.autoSeqCheck.checked;
        
        // æ›´æ–°å…¨åŸŸè¨˜æ†¶è®Šæ•¸
        currentAutoState = data.isAuto;

        // --- â­ v8.6/v8.7: æ™ºæ…§è‡ªå‹•ä»£å…¥æª”å ---
        if (!data.isAuto) {
            // æ¢ä»¶ï¼šæ²’æœ‰åˆ†é¡ AND æ²’æœ‰æ¨™ç±¤ AND ç›®å‰è‡ªè¨‚åç¨±æ˜¯ç©ºçš„
            if (!data.category && data.tags.size === 0 && !data.customName) {
                // å–å¾—åŸå§‹æª”åï¼Œä¸¦å»é™¤å‰¯æª”å
                let nameWithoutExt = data.originalName.replace(/\.[^/.]+$/, "");
                data.customName = nameWithoutExt;
                UI.customInput.value = nameWithoutExt;
            }
        }
        // --- çµæŸ ---

        updateUI(); 
        if (!data.isAuto) {
            setTimeout(() => { UI.customInput.focus(); }, 50);
        }
    }

    function onCustomInputChange(input) {
        let val = input.value.replace(/[\\/:*?"<>|]/g, ''); 
        input.value = val;
        let data = getData();
        data.customName = val;
        updateUI();
    }

    // --- â­ v8.8 æª”åç”Ÿæˆ (å„ªåŒ–ç„¡åˆ†é¡é‚è¼¯) ---
    function generateFilename(d, seqNum) {
        // å¦‚æœæ²’æœ‰åˆ†é¡ï¼Œä¸å›å‚³ _æœªåˆ†é¡ï¼Œæ”¹å›å‚³ç©ºå­—ä¸² (é¿å…æª”åè®Šæˆ _æœªåˆ†é¡_æª”å)
        let safeCategory = d.category ? d.category.replace(/[\\/:*?"<>|]/g, '_') : "";
        
        let parts = [];
        if(safeCategory) parts.push(safeCategory);
        
        tags.forEach(t => { 
            if(d.tags.has(t.name)) parts.push(t.name.replace(/[\\/:*?"<>|]/g, '_')); 
        });

        let ext = "jpg"; 
        if(d.originalName) ext = d.originalName.split('.').pop().toLowerCase(); 
        
        let finalName = "";
        let startOffset = parseInt(UI.startSeqInput.value) || 1;
        
        if(d.isAuto !== false) { 
            let actualSeq = seqNum + startOffset - 1;
            let seqStr = String(actualSeq).padStart(3,'0');
            finalName = `${parts.join('_')}_${seqStr}.${ext}`;
            // ä¿®æ­£ï¼šå¦‚æœ parts ç‚ºç©º (æ²’åˆ†é¡æ²’æ¨™ç±¤)ï¼Œé¿å…é–‹é ­å‡ºç¾ _
            if(parts.length === 0) finalName = `${seqStr}.${ext}`;
        } else { 
            let cust = d.customName || "åç¨±";
            // ä¿®æ­£ï¼šå¦‚æœ parts ç‚ºç©ºï¼Œç›´æ¥ç”¨è‡ªè¨‚æª”å
            if(parts.length === 0) finalName = `${cust}.${ext}`;
            else finalName = `${parts.join('_')}_${cust}.${ext}`;
        }
        return finalName;
    }

    function updateUI() {
        let data = getData();
        
        UI.trashOverlay.style.display = data.isDeleted ? 'flex' : 'none';
        
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', !data.isDeleted && b.dataset.val === data.category));
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.toggle('active', data.tags.has(b.dataset.val)));

        UI.autoSeqCheck.checked = (data.isAuto !== false); 
        UI.customInput.value = data.customName || "";
        UI.customInput.disabled = UI.autoSeqCheck.checked;
        
        if(!isDemoMode) {
            UI.infoFilename.textContent = data.originalName;
            UI.infoProgress.textContent = `é€²åº¦: ${currentIndex + 1} / ${files.length}`;
        }

        let finalName = ""; // åœ¨é€™è£¡å®£å‘Šï¼Œè®“å¾Œé¢çš„å°èˆªåˆ—å¯ä»¥ç”¨

        if (data.isDeleted) {
            UI.preview.textContent = "ğŸ—‘ï¸ å°‡ç§»è‡³å›æ”¶æ¡¶";
            UI.preview.style.color = "#dc3545";
        } else {
            // â­ v8.10 ä¿®æ­£ï¼šç¾åœ¨æœªåˆ†é¡ä¹Ÿæœƒè¨ˆç®—æµæ°´è™Ÿï¼Œé¿å…å…¨éƒ¨é¡¯ç¤ºç‚º 001
            let seqNum = 1;
            if(!isDemoMode) {
                // å¦‚æœæœ‰åˆ†é¡ï¼Œè¨ˆç®—è©²åˆ†é¡çš„åºè™Ÿ
                if(data.category) {
                    seqNum = 0;
                    for(let i=0; i<=currentIndex; i++) {
                        if(fileData[i].category === data.category && !fileData[i].isDeleted) {
                            seqNum++;
                        }
                    }
                    if(seqNum === 0) seqNum = 1;
                } else {
                    // å¦‚æœæ²’åˆ†é¡ï¼Œè¨ˆç®—ã€Œæœªåˆ†é¡ã€çš„åºè™Ÿ
                    seqNum = 0;
                    for(let i=0; i<=currentIndex; i++) {
                        if(!fileData[i].category && !fileData[i].isDeleted) {
                            seqNum++;
                        }
                    }
                    if(seqNum === 0) seqNum = 1;
                }
            }
            
            finalName = generateFilename(data, seqNum);
            let safeCat = data.category ? data.category.replace(/[\\/:*?"<>|]/g, '_') : "";
            
            // â­ v8.9 ä¿®æ”¹ï¼šå¦‚æœæ²’æœ‰åˆ†é¡ï¼Œé¡¯ç¤ºç•¶å‰ç›®éŒ„ ./
            let prefix = safeCat ? `${safeCat}\\` : ".\\";

            UI.preview.textContent = `å­˜æª”ç‚º: ${prefix}${finalName}`;
            UI.preview.style.color = "#333";
        }

        // --- â­ æ–°å¢ï¼šåŒæ­¥æ›´æ–°ä¸Šæ–¹å°èˆªåˆ—è³‡è¨Š â­ ---
        const navStats = document.getElementById('navStats');
        const navOrigin = document.getElementById('navOriginName');
        const navTarget = document.getElementById('navTargetName');

        if (!isDemoMode && files.length > 0) {
            navStats.style.display = 'flex'; // é¡¯ç¤ºå€å¡Š
            navOrigin.textContent = data.originalName; // é¡¯ç¤ºåŸå§‹æª”å

            if (data.isDeleted) {
                // å¦‚æœæ˜¯åˆªé™¤ç‹€æ…‹
                navTarget.textContent = "ğŸ—‘ï¸ åˆªé™¤";
                navTarget.style.color = "#dc3545"; // ç´…è‰²
                navTarget.style.background = "#fee2e2";
            } else {
                // æ­£å¸¸ç‹€æ…‹
                if (finalName) {
                    navTarget.textContent = finalName;
                    navTarget.style.color = "#0d6efd"; // è—è‰²
                    navTarget.style.background = "#e7f1ff";
                }
            }
        }

        // --- â­ æ–°å¢ï¼šå¦‚æœæ­·å²é¢æ¿é–‹è‘—ï¼Œå°±è‡ªå‹•æ›´æ–°å…§å®¹ â­ ---
        const panel = document.getElementById('historyPanel');
        if (panel && panel.classList.contains('active')) {
            renderHistory();
        }
    }
    
    // --- éµç›¤ç›£è½ ---
    document.addEventListener('keydown', (e) => {
        if (UI.welcomeOverlay.style.display !== 'none') return;
        if (UI.helpModal.style.display === 'flex' || UI.settingsModal.style.display === 'flex') return;
        
        if(e.key === "F2") {
            e.preventDefault();
            UI.autoSeqCheck.checked = !UI.autoSeqCheck.checked;
            toggleNamingMode();
            return;
        }

        if (document.activeElement === UI.customInput || document.activeElement === UI.startSeqInput) { 
            if(e.key === "Enter") nextImage(); 
            return; 
        }

        const key = e.key.toLowerCase();
        if (key === 'delete') markDeleted();
        else if (key === 'r') rotateImage();
        else if (key === 'enter' && !isDemoMode && !isTourActive) nextImage();
        else if (key === 'arrowleft' && !isDemoMode && !isTourActive) prevImage();
        else if (key === 'arrowright' && !isDemoMode && !isTourActive) nextImage();
        else if (keyMap[key]) {
            const act = keyMap[key];
            if (act.type === 'cat') selectCategory(act.val);
            if (act.type === 'tag') toggleTag(act.val);
            
            const btn = document.getElementById(`${act.type}_${key.toUpperCase()}`);
            if(btn) { btn.style.transform = "scale(0.95)"; setTimeout(()=>btn.style.transform="scale(1)", 100); }
        }
    });

    // --- å°è¦½æµç¨‹ ---
    function skipTour() { UI.welcomeOverlay.style.display = 'none'; endDemoMode(); }
    function startTour() {
        UI.welcomeOverlay.style.display = 'none';
        isTourActive = true;
        document.body.classList.add('tour-active');
        UI.img.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgODAwIDYwMCI+CiAgPHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI2MDAiIGZpbGw9IiMzMzMiIC8+CiAgPHRleHQgeD0iNTA1IiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM4ODgiIGZvbnQtZmFtaWx5PSJNaWNyb3NvZnQgSmhlbmdIZWksIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjQiPuabt+WbuuWcqOatpCAo6KKu5pSl6Yg45pW06auU54mHKTwvdGV4dD4KPC9zdmc+";
        UI.placeholder.style.display = 'none';
        UI.img.style.display = 'block';
        
        UI.dimmer.style.display = 'block';
        tourStep = 1; showTourStep(1);
    }
    function showTourStep(step) {
        document.querySelectorAll('.spotlight').forEach(el => { el.classList.remove('spotlight'); el.classList.remove('allow-click'); });
        const tooltip = UI.tourTooltip;
        tooltip.style.display = 'block';
        
        if(step===1) { setupTip(1, "é¸æ“‡ä¸»åˆ†é¡", `è«‹æŒ‰éµç›¤ '${categories[0].key}' é¸æ“‡ ${categories[0].name}`, `cat_${categories[0].key}`, 'right'); }
        else if(step===2) { setupTip(2, "åŠ ä¸Šå­æ¨™ç±¤", `è«‹æŒ‰éµç›¤ '${tags[0].key}' åŠ ä¸Š ${tags[0].name}`, `tag_${tags[0].key}`, 'right'); }
        else if(step===3) { setupTip(3, "åˆªé™¤å»¢ç‰‡", "æŒ‰ 'Delete' éµä¸Ÿæ£„ç…§ç‰‡", 'imgPanel', 'center'); }
        else if(step===4) {
            UI.dimmer.style.display = 'none'; tooltip.style.display = 'none';
            document.body.classList.remove('tour-active'); isTourActive = false;
            alert("ğŸ‰ ç·´ç¿’çµæŸï¼åŠŸèƒ½å…¨è§£é–ã€‚"); endDemoMode();
        }
    }
    function setupTip(num, title, desc, targetId, pos) {
        document.getElementById('tourStepBadge').innerText = num;
        document.getElementById('tourText').innerText = title;
        document.getElementById('tourSubText').innerText = desc;
        let el = document.getElementById(targetId);
        if(el) {
            el.classList.add('spotlight'); el.classList.add('allow-click');
            let rect = el.getBoundingClientRect();
            if(pos==='right') { UI.tourTooltip.style.top = rect.top+"px"; UI.tourTooltip.style.left = (rect.left - 320)+"px"; }
            else { UI.tourTooltip.style.top = "50%"; UI.tourTooltip.style.left = "50%"; UI.tourTooltip.style.transform = "translate(-50%, -50%)"; }
        }
    }
    function nextTourStep() { setTimeout(() => { tourStep++; showTourStep(tourStep); }, 500); }
    function forceNextStep() { nextTourStep(); }
    function endDemoMode() {
        isDemoMode = false;
        demoData = { category: null, tags: new Set(), isDeleted: false, isAuto: true };
        updateUI();
        
        UI.img.src = "";
        UI.img.style.display = 'none';
        UI.placeholder.style.display = 'block';
    }

    // --- çœŸå¯¦æª”æ¡ˆ ---
    document.getElementById('folderInput').addEventListener('change', function(e) {
        // v8.6: å¢åŠ  HEIC æª¢æŸ¥
        let tempFiles = Array.from(e.target.files);
        let hasHeic = tempFiles.some(f => f.name.toLowerCase().endsWith('.heic'));
        
        if(hasHeic) {
            alert("âš ï¸ åµæ¸¬åˆ° .HEIC æ ¼å¼ç…§ç‰‡ï¼\n\nWindows ç€è¦½å™¨ä¸æ”¯æ´ç›´æ¥é è¦½æ­¤æ ¼å¼ï¼Œæ‚¨å¯èƒ½æœƒçœ‹åˆ°å…¨é»‘æˆ–ç ´æçš„åœ–ç‰‡ã€‚\nå»ºè­°å…ˆå°‡ iPhone ç…§ç‰‡è½‰ç‚º JPG å¾Œå†ä½¿ç”¨ã€‚");
        }

        files = tempFiles.filter(f => f.type.startsWith('image/') || f.name.toLowerCase().endsWith('.heic'));
        if (!files.length) { alert("æ²’æœ‰åœ–ç‰‡ï¼"); return; }
        
        fileData = files.map(f => ({ originalName: f.name, category: null, tags: new Set(), isDeleted: false, isAuto: true, customName: "" }));
        const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
        files.sort((a, b) => collator.compare(a.name, b.name));
        fileData.sort((a, b) => collator.compare(a.originalName, b.originalName));
        
        currentIndex = 0; 
        
        UI.downloadBtn.classList.add('active'); 
        UI.reportBtn.classList.add('active'); 
        
        UI.placeholder.style.display = 'none';
        UI.img.style.display = 'block';
        UI.infoBar.style.display = 'flex'; 
        
        loadRealImage();
    });
    
    function loadRealImage() {
        if (!files.length) return;
        const img = document.getElementById('currentImage');
        if (img.src) URL.revokeObjectURL(img.src);
        img.src = URL.createObjectURL(files[currentIndex]);
        
        img.style.transform = "rotate(0deg)"; rotationDeg = 0;
        
        // v8.4: æ™ºæ…§ç‹€æ…‹ç¹¼æ‰¿
        let d = fileData[currentIndex];
        
        if(d.customName === "" && d.isAuto === true) {
            d.isAuto = currentAutoState;
        }

        // --- â­ v8.7: åˆ‡æ›ç…§ç‰‡æ™‚ä¹Ÿè¦æª¢æŸ¥æ˜¯å¦éœ€è¦æ™ºæ…§ä»£å…¥ ---
        // é‚è¼¯: è‡ªè¨‚æ¨¡å¼(!isAuto) ä¸” æ²’åˆ†é¡ ä¸” æ²’æ¨™ç±¤ ä¸” æ²’åå­—
        if (!d.isAuto && !d.category && d.tags.size === 0 && !d.customName) {
            let nameWithoutExt = d.originalName.replace(/\.[^/.]+$/, "");
            d.customName = nameWithoutExt;
        }
        // ------------------------------------------------

        updateUI();
    }

    function nextImage() {
        if(currentIndex < files.length - 1) {
            let prevCat = fileData[currentIndex].category;
            currentIndex++;
            if(isLocked && prevCat && !fileData[currentIndex].category) {
                fileData[currentIndex].category = prevCat; 
            }
            loadRealImage();
        } else alert("ğŸ‰ å…¨éƒ¨å®Œæˆï¼");
    }
    function prevImage() { if(currentIndex > 0) { currentIndex--; loadRealImage(); } }

    // --- Modal èˆ‡ è¨­å®š ---
    function openHelpModal(tab) { UI.helpModal.style.display = 'flex'; switchTab(tab); }
    function closeHelpModal() { UI.helpModal.style.display = 'none'; }
    function switchTab(t) {
        document.querySelectorAll('.modal-body').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(t).classList.add('active'); document.getElementById('btn-'+t).classList.add('active');
    }
    
    function openSettings() {
        // ç”¢ç”Ÿä¸»åˆ†é¡è¨­å®šåˆ—è¡¨
        const cBody = document.getElementById('catSettingsBody'); 
        cBody.innerHTML = '';
        categories.forEach((c,i) => {
            // æ³¨æ„ï¼šé€™è£¡ç§»é™¤äº† maxlength="1"ï¼Œç¾åœ¨å¯ä»¥è¼¸å…¥ä»»æ„é•·åº¦çš„æ–‡å­—
            cBody.innerHTML += `
                <tr>
                    <td><input class="settings-input" value="${c.name}" onchange="categories[${i}].name=this.value"></td>
                    <td><input class="settings-input key-input" value="${c.key}" onchange="categories[${i}].key=this.value" placeholder="ç„¡"></td>
                    <td><button class="icon-btn btn-del" onclick="event.stopPropagation(); categories.splice(${i},1); openSettings()">Ã—</button></td>
                </tr>`;
        });
        
        // ç”¢ç”Ÿå­æ¨™ç±¤è¨­å®šåˆ—è¡¨
        const tBody = document.getElementById('tagSettingsBody'); 
        tBody.innerHTML = '';
        tags.forEach((t,i) => {
            // æ³¨æ„ï¼šé€™è£¡ä¹Ÿç§»é™¤äº† maxlength="1"
            tBody.innerHTML += `
                <tr>
                    <td><input class="settings-input" value="${t.name}" onchange="tags[${i}].name=this.value"></td>
                    <td><input class="settings-input key-input" value="${t.key}" onchange="tags[${i}].key=this.value" placeholder="ç„¡"></td>
                    <td><button class="icon-btn btn-del" onclick="event.stopPropagation(); tags.splice(${i},1); openSettings()">Ã—</button></td>
                </tr>`;
        });

        UI.settingsModal.style.display = 'flex';
    } 

    function closeSettings() { UI.settingsModal.style.display = 'none'; }
    
    function saveSettings() {
        // --- â­ æ–°å¢ï¼šæª¢æŸ¥é‡è¤‡æŒ‰éµé‚è¼¯ ---
        let usedKeys = new Set();
        let hasError = false;

        // å®šç¾©ä¸€å€‹æª¢æŸ¥å‡½æ•¸
        const checkDuplicate = (list, typeName) => {
            for (let item of list) {
                // å°‡æŒ‰éµè½‰ç‚ºå°å¯«ä¸¦å»é™¤ç©ºç™½ï¼Œç¢ºä¿æ¯”å°æº–ç¢º
                let k = (item.key || "").trim().toLowerCase();
                
                if (k) { // å¦‚æœæœ‰è¨­å®šæŒ‰éµæ‰æª¢æŸ¥
                    if (usedKeys.has(k)) {
                        alert(`âŒ å„²å­˜å¤±æ•—ï¼\n\næŒ‰éµ "${item.key.toUpperCase()}" é‡è¤‡äº†ï¼\nè«‹æª¢æŸ¥ã€Œ${typeName}ï¼š${item.name}ã€`);
                        return true; // ç™¼ç¾é‡è¤‡ï¼Œå›å‚³ true
                    }
                    usedKeys.add(k);
                }
            }
            return false;
        };

        // é–‹å§‹æª¢æŸ¥
        if (checkDuplicate(categories, "ä¸»åˆ†é¡")) return; // å¦‚æœæœ‰éŒ¯å°±ä¸­æ–·ï¼Œä¸å­˜æª”
        if (checkDuplicate(tags, "å­æ¨™ç±¤")) return;

        // --- æª¢æŸ¥é€šéï¼ŒåŸ·è¡Œå„²å­˜ ---
        initUI(); 
        closeSettings();
        updateUI();
        
        // ç¨å¾®æç¤ºä¸€ä¸‹ä½¿ç”¨è€…æˆåŠŸäº†
        // alert("è¨­å®šå·²å„²å­˜ï¼"); // (é¸ç”¨)
    }
    function addCatRow() { categories.push({name:"", key:""}); openSettings(); }
    function addTagRow() { tags.push({name:"", key:""}); openSettings(); }

    // --- â­ æ–°å¢ï¼šæ­·å²ç´€éŒ„åŠŸèƒ½é‚è¼¯ â­ ---
    
    // 1. é–‹é—œæŠ½å±œ
    function toggleHistory() {
        const panel = document.getElementById('historyPanel');
        panel.classList.toggle('active');
        
        // å¦‚æœæ˜¯æ‰“é–‹ç‹€æ…‹ï¼Œå°±æ›´æ–°æ¸…å–®
        if (panel.classList.contains('active')) {
            renderHistory();
        }
    }

    // 2. ç”¢ç”Ÿæ¸…å–® (æ ¸å¿ƒé‚è¼¯)
    function renderHistory() {
        if (fileData.length === 0) return;

        const listDiv = document.getElementById('historyList');
        listDiv.innerHTML = '';

        // æº–å‚™è¨ˆæ•¸å™¨ (é‚è¼¯åŒ exportBat)
        let counts = {};
        let noCatSeq = 0;

        // å¾é ­é–‹å§‹æƒææ¯ä¸€å¼µç…§ç‰‡
        fileData.forEach((d, i) => {
            // åªé¡¯ç¤ºã€Œå·²ç¶“è™•ç†éã€æˆ–æ˜¯ã€Œç•¶å‰é€™å¼µã€çš„ç…§ç‰‡
            if (i > currentIndex) return; 

            let displayHtml = "";
            let isCurrent = (i === currentIndex);

            if (d.isDeleted) {
                // åˆªé™¤çš„ç…§ç‰‡
                displayHtml = `<span class="history-trash">ğŸ—‘ï¸ ${d.originalName}</span>`;
            } else {
                // æ­£å¸¸ç…§ç‰‡ï¼Œè¨ˆç®—æª”å
                let finalName = "";
                
                if (!d.category) {
                    // æœªåˆ†é¡ (åŸåœ°)
                    noCatSeq++;
                    finalName = generateFilename(d, noCatSeq);
                } else {
                    // æœ‰åˆ†é¡
                    if (!counts[d.category]) counts[d.category] = 0;
                    counts[d.category]++;
                    finalName = generateFilename(d, counts[d.category]);
                }
                
                // å»é™¤å‰¯æª”åï¼Œè®“ç•«é¢ä¹¾æ·¨é»
                let shortName = finalName.split('.')[0];
                displayHtml = `<span class="${isCurrent ? '' : 'history-seq'}">${shortName}</span>`;
            }

            // å»ºç«‹ HTML å…ƒç´ 
            let div = document.createElement('div');
            div.className = `history-item ${isCurrent ? 'current' : ''}`;
            div.innerHTML = `
                ${displayHtml}
                <span style="font-size:12px; color:#999;">#${i+1}</span>
            `;
            
            // æ–°çš„æœ€ä¸Šé¢ (å€’åº)
            listDiv.insertBefore(div, listDiv.firstChild);
        });
    }

    // --- Export BAT (v8.10: ä¿®æ­£æœªåˆ†é¡çš„åŸåœ°æ”¹å + æµæ°´è™Ÿé‚è¼¯) ---
    function exportBat() {
        if(isDemoMode) { alert("è«‹å…ˆè¼‰å…¥çœŸå¯¦ç…§ç‰‡ï¼"); return; }
        if(!files.length) return;
        let bat = "@echo off\r\nchcp 65001 >nul\r\necho æ­£åœ¨æ•´ç†ç…§ç‰‡...\r\n\r\n";
        
        let folders = new Set(); folders.add("_TRASH");
        
        fileData.forEach(d => { 
            if(d.category && !d.isDeleted) folders.add(d.category.replace(/[\\/:*?"<>|]/g, '_')); 
        });
        folders.forEach(f => bat += `if not exist "${f}" md "${f}"\r\n`);
        bat += "\r\n";

        let counts = {};
        let unsortedCount = 0;
        let noCatSeq = 0; // â­ v8.10 æ–°å¢ï¼šæœªåˆ†é¡çš„ç¨ç«‹æµæ°´è™Ÿè¨ˆæ•¸å™¨
        
        fileData.forEach(d => {
            if(d.isDeleted) { 
                bat += `move "${d.originalName}" "_TRASH\\${d.originalName}"\r\n`; 
                return; 
            }
            
            let safeCat = "";
            let finalName = "";
            let targetPath = "";

            if(!d.category) {
                // æœªåˆ†é¡ = åŸåœ°æ”¹å
                unsortedCount++;
                noCatSeq++; // ç´¯åŠ æœªåˆ†é¡çš„è¨ˆæ•¸
                finalName = generateFilename(d, noCatSeq); // å‚³å…¥è¨ˆæ•¸
                targetPath = finalName;
            } else {
                // æœ‰åˆ†é¡ = ç§»å…¥è³‡æ–™å¤¾
                safeCat = d.category.replace(/[\\/:*?"<>|]/g, '_');
                if(!counts[d.category]) counts[d.category]=0;
                counts[d.category]++;
                finalName = generateFilename(d, counts[d.category]);
                targetPath = `${safeCat}\\${finalName}`;
            }
            
            bat += `if not exist "${targetPath}" (\r\n`;
            bat += `  move "${d.originalName}" "${targetPath}"\r\n`;
            bat += `) else (\r\n`;
            bat += `  echo [ç•¥é] æª”æ¡ˆå·²å­˜åœ¨: "${targetPath}"\r\n`;
            bat += `)\r\n`;
        });
        
        bat += `\r\necho æ•´ç†å®Œæˆï¼ (å« ${unsortedCount} å¼µåŸåœ°æ”¹å)\r\npause`;
        
        const blob = new Blob([bat], {type: 'text/plain;charset=utf-8'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "é–‹å§‹æ•´ç†.bat";
        link.click();
    }

    // --- Export Report ---
    function exportReport() {
        if(isDemoMode) { alert("è«‹å…ˆè¼‰å…¥çœŸå¯¦ç…§ç‰‡ï¼"); return; }
        if(!files.length) return;

        let script = `
        <script>
            function copyText(el) {
                let text = el.innerText.trim();
                navigator.clipboard.writeText(text).then(() => {
                    let originalText = el.getAttribute('data-text') || text;
                    el.setAttribute('data-text', originalText);
                    el.classList.add('copied');
                    el.innerHTML = 'âœ… å·²è¤‡è£½';
                    setTimeout(() => {
                        el.innerHTML = 'âœ” ' + originalText; 
                        el.classList.add('checked');
                    }, 800);
                });
            }
        <\/script>
        `;

        let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>ç…§ç‰‡å°ç…§è¡¨ (é›™æ¬„ç‰ˆ)</title>
            <style>
                body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background: #f0f0f0; }
                .container { max-width: 1000px; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 0 20px rgba(0,0,0,0.1); min-height: 100vh; }
                h1 { text-align: center; border-bottom: 3px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                h2 { background: #333; color: white; padding: 10px; margin-top: 40px; border-radius: 4px; }
                .photo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                .photo-card { border: 2px solid #000; display: flex; flex-direction: column; background: white; break-inside: avoid; }
                .card-header { 
                    padding: 10px; background: white; border-bottom: 2px solid #000; 
                    text-align: center; font-weight: bold; font-size: 16px; 
                    cursor: pointer; transition: 0.2s; user-select: none;
                }
                .card-header:hover { background: #e7f1ff; color: #0d6efd; }
                .card-header.copied { background: #198754; color: white !important; }
                .card-header.checked { color: #198754; background: #f0fff4; }
                .img-box { 
                    width: 100%; height: 300px; 
                    display: flex; align-items: center; justify-content: center; 
                    overflow: hidden; background: #eee;
                }
                .img-box img { width: 100%; height: 100%; object-fit: contain; }
                .note-box { border-top: 1px solid #ccc; padding: 5px; background: #fff; }
                .note-input { 
                    width: 100%; border: none; outline: none; resize: none; 
                    font-family: inherit; font-size: 13px; color: #666; height: 30px; 
                    background: transparent;
                }
                .note-input::placeholder { color: #ddd; font-style: italic; }
                @media print {
                    body { background: white; padding: 0; }
                    .container { box-shadow: none; max-width: 100%; padding: 20px; }
                    h2 { background: transparent; color: black; border-bottom: 2px solid black; padding-left: 0; }
                    .card-header { border-bottom: 1px solid #000; }
                    .photo-card { border: 1px solid #000; }
                    .note-input { display: block; }
                }
            </style>
            ${script}
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“„ ç¾å ´ç…§ç‰‡å°ç…§è¡¨</h1>
                <div class="important-box" style="background:#fff3cd; padding:10px; margin-bottom:20px; border:1px solid #ffeeba;">
                    âš ï¸ è«‹å…ˆåŸ·è¡Œ <b>.bat</b> æª”æ¡ˆæ­¸æª”ç…§ç‰‡å¾Œï¼Œæ­¤è¡¨åœ–ç‰‡æ‰èƒ½æ­£å¸¸é¡¯ç¤ºã€‚
                </div>
        `;

        // 1. å…ˆé¡¯ç¤ºæœ‰åˆ†é¡çš„
        let globalCounts = {};
        categories.forEach(cat => {
            let catPhotos = fileData.filter(d => !d.isDeleted && d.category === cat.name);
            if (catPhotos.length > 0) {
                html += `<h2>ğŸ“‚ ${cat.name}</h2><div class="photo-grid">`;
                catPhotos.forEach((d) => {
                    if(!globalCounts[d.category]) globalCounts[d.category]=0;
                    globalCounts[d.category]++;
                    let finalName = generateFilename(d, globalCounts[d.category]);
                    
                    let safeCat = d.category.replace(/[\\/:*?"<>|]/g, '_');
                    
                    let ext = d.originalName.split('.').pop().toLowerCase();
                    let captionText = finalName.replace('.'+ext, '');
                    let relPath = `${safeCat}/${finalName}`;
                    html += `
                        <div class="photo-card">
                            <div class="card-header" onclick="copyText(this)">${captionText}</div>
                            <div class="img-box"><img src="${relPath}" loading="lazy" alt="åœ–ç‰‡"></div>
                            <div class="note-box"><textarea class="note-input" placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨»..."></textarea></div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
        });

        // â­ v8.10 æ–°å¢ï¼šé¡¯ç¤ºæœªåˆ†é¡ (åŸåœ°ä¿ç•™) çš„ç…§ç‰‡
        let uncategorized = fileData.filter(d => !d.isDeleted && !d.category);
        if (uncategorized.length > 0) {
            html += `<h2>ğŸ“‚ æœªåˆ†é¡ / åŸåœ°ä¿ç•™</h2><div class="photo-grid">`;
            let uncatCount = 0;
            uncategorized.forEach((d) => {
                uncatCount++;
                let finalName = generateFilename(d, uncatCount);
                
                let ext = d.originalName.split('.').pop().toLowerCase();
                let captionText = finalName.replace('.'+ext, '');
                // åŸåœ°ä¿ç•™çš„ç…§ç‰‡ï¼Œè·¯å¾‘å°±æ˜¯æª”å (å› ç‚º html å’Œç…§ç‰‡åœ¨åŒä¸€å±¤)
                let relPath = finalName; 

                html += `
                    <div class="photo-card">
                        <div class="card-header" onclick="copyText(this)">${captionText}</div>
                        <div class="img-box"><img src="${relPath}" loading="lazy" alt="åœ–ç‰‡"></div>
                        <div class="note-box"><textarea class="note-input" placeholder="åœ¨æ­¤è¼¸å…¥å‚™è¨»..."></textarea></div>
                    </div>
                `;
            });
            html += `</div>`;
        }

        html += `</div></body></html>`;

        const blob = new Blob([html], {type: 'text/html;charset=utf-8'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "åƒç…§è¡¨.html";
        link.click();
    }
</script>
</body>
</html>
