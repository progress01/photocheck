<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ­¸æª”ç¥å™¨ (åœ–å½¢åŒ–è¨­å®šç‰ˆ)</title>
    <style>
        :root { --primary: #0d6efd; --danger: #dc3545; --bg: #f8f9fa; --border: #dee2e6; }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; }
        
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-title { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; font-weight: bold; }

        .main-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; flex: 1; min-height: 0; }
        
        .image-panel { background: #222; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .image-panel img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
        .placeholder-text { color: #888; text-align: center; line-height: 1.6; }

        .sidebar { background: white; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-title { font-size: 0.95rem; font-weight: bold; color: #555; margin-bottom: 8px; border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items:end; }
        
        .info-card { background: #e9ecef; padding: 12px; border-radius: 6px; font-size: 0.9rem; border-left: 5px solid var(--primary); }
        
        /* åˆ†é¡æŒ‰éˆ•å€ */
        #categoryContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .cat-btn { 
            background: white; border: 1px solid #ccc; padding: 10px 5px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; text-align: center; transition: 0.2s; user-select: none;
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .cat-btn:hover { background: #f1f3f5; border-color: #adb5bd; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3); }
        .key-badge {
            font-size: 10px; background: #333; color: #fff; padding: 1px 5px; border-radius: 4px; 
            position: absolute; top: 2px; right: 2px; opacity: 0.7; font-family: monospace;
        }
        .cat-btn.active .key-badge { background: white; color: var(--primary); }

        /* å‘½åèˆ‡è¨­å®šæŒ‰éˆ• */
        .config-btn { width: 100%; padding: 10px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .config-btn:hover { background: #5a6268; }

        .naming-control { border: 1px solid #eee; padding: 15px; border-radius: 8px; background: #fafafa; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; cursor: pointer; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }

        .input-wrapper { position: relative; }
        .custom-input { width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: 6px; font-size: 15px; box-sizing: border-box; transition: 0.3s; background: #fff; }
        .custom-input:disabled { background: #e9ecef; color: #aaa; border-color: #eee; cursor: not-allowed; }
        .error-msg { color: var(--danger); font-size: 12px; margin-top: 4px; display: none; font-weight: bold; }
        .preview-text { font-size: 0.85rem; color: #666; margin-top: 8px; text-align: right; font-family: monospace; background: #e9ecef; padding: 4px 8px; border-radius: 4px; }

        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; }
        .btn-upload { background: #198754; color: white; display: inline-flex; align-items: center; gap: 5px; }
        .btn-help { background: #6f42c1; color: white; }
        .btn-prev { background: #6c757d; color: white; }
        .btn-next { background: var(--primary); color: white; flex: 1; }
        .btn-download { background: #fd7e14; color: white; width: 100%; padding: 15px; font-size: 16px; margin-top: auto; display: flex; justify-content: center; align-items: center; gap: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-download:hover { background: #e96b02; transform: translateY(-2px); }

        /* é€šç”¨ Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 600px; border-radius: 12px; padding: 20px; position:relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;}
        .close-btn { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; background:none; border:none; }

        /* è¨­å®šè¡¨æ ¼æ¨£å¼ */
        .settings-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .settings-table th { text-align: left; padding: 8px; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
        .settings-table td { padding: 8px; border-bottom: 1px solid #f0f0f0; }
        .settings-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .key-input { width: 50px; text-align: center; text-transform: uppercase; font-family: monospace; font-weight: bold; }
        .del-btn { color: #dc3545; cursor: pointer; font-weight: bold; text-align: center; }
        .add-row-btn { margin-top: 10px; background: #e9ecef; color: #333; width: 100%; padding: 8px; border: 1px dashed #ccc; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .add-row-btn:hover { background: #e2e6ea; }
        .save-btn { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; width: 100%; font-size: 16px; }

    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-title">ğŸ“· ç…§ç‰‡æ­¸æª”ç¥å™¨</div>
    <div class="nav-actions">
        <button class="btn btn-help" onclick="showHelp()">â“ æ•™å­¸</button>
        <label for="folderInput" class="btn btn-upload" style="cursor:pointer;">ğŸ“‚ é¸æ“‡è³‡æ–™å¤¾</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
    </div>
</div>

<div class="main-layout">
    <div class="image-panel">
        <img id="currentImage" src="" alt="">
        <div id="placeholder" class="placeholder-text">
            <h3>è«‹é¸æ“‡ç…§ç‰‡è³‡æ–™å¤¾é–‹å§‹</h3>
            <p>1. é»æ“Šã€Œè¨­å®šåˆ†é¡ã€èª¿æ•´æŒ‰éˆ•<br>2. é¸æ“‡åˆ†é¡ â” ä¸‹ä¸€å¼µ</p>
        </div>
    </div>

    <div class="sidebar">
        <div>
            <div class="section-title">âš™ï¸ åˆ†é¡è¨­å®š</div>
            <button class="config-btn" onclick="openSettings()">
                <span>âœï¸ ç·¨è¼¯åˆ†é¡èˆ‡å¿«æ·éµ</span>
            </button>
        </div>

        <div class="info-card">
            <div>åŸå§‹æª”å: <strong id="fileName">-</strong></div>
            <div style="margin-top:5px;">é€²åº¦: <span id="progress">0 / 0</span></div>
        </div>

        <div>
            <div class="section-title">ğŸ“‚ é¸æ“‡åˆ†é¡ (æŒ‰éµç›¤é¸å–)</div>
            <div id="categoryContainer"></div>
        </div>

        <div class="naming-control">
            <div class="section-title" style="border:none; margin-bottom:10px;">âœï¸ å‘½åè¨­å®š</div>
            
            <label class="toggle-row">
                <span style="font-weight:bold; color:#555;">ä½¿ç”¨æµæ°´è™Ÿ (_001)</span>
                <label class="switch">
                    <input type="checkbox" id="autoSeqCheck" checked onchange="toggleNamingMode()">
                    <span class="slider"></span>
                </label>
            </label>

            <div class="input-wrapper">
                <input type="text" id="customInput" class="custom-input" placeholder="è¼¸å…¥è‡ªè¨‚åç¨±..." disabled oninput="validateInput(this)" onkeydown="checkEnter(event)">
                <div id="errorMsg" class="error-msg">âš ï¸ æª”ååŒ…å«éæ³•å­—å…ƒ</div>
            </div>

            <div id="finalPreview" class="preview-text">é è¦½: è«‹å…ˆé¸æ“‡åˆ†é¡</div>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-prev" onclick="prevImage()">â† ä¸Šä¸€å¼µ (â†)</button>
            <button class="btn btn-next" onclick="nextImage()">ä¸‹ä¸€å¼µ (Enter)</button>
        </div>

        <button class="btn btn-download" onclick="exportBat()">
            <span>âš¡ ä¸‹è¼‰æ•´ç†åŸ·è¡Œæª” (.bat)</span>
        </button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay" onclick="closeSettings()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="closeSettings()">&times;</button>
        <h2 style="margin-top:0;">ğŸ› ï¸ ç·¨è¼¯åˆ†é¡</h2>
        <p style="color:#666; font-size:14px; margin-bottom:10px;">è«‹åœ¨ä¸‹æ–¹è¼¸å…¥åˆ†é¡åç¨±ï¼Œä¸¦æŒ‡å®šä¸€å€‹éµç›¤æŒ‰éµ (å¯é¸)ã€‚</p>
        
        <table class="settings-table">
            <thead>
                <tr>
                    <th style="width: 60%;">åˆ†é¡åç¨± (è³‡æ–™å¤¾å)</th>
                    <th style="width: 25%;">å¿«æ·éµ</th>
                    <th style="width: 15%;">åˆªé™¤</th>
                </tr>
            </thead>
            <tbody id="settingsBody">
                </tbody>
        </table>
        
        <button class="add-row-btn" onclick="addSettingRow()">+ æ–°å¢ä¸€åˆ—</button>
        <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>
</div>

<div id="helpModal" class="modal-overlay" onclick="showHelp()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-btn" onclick="showHelp()">&times;</button>
        <h2 style="margin-top:0;">ğŸš€ æ“ä½œæŒ‡å—</h2>
        <div style="margin-bottom:20px;">
            <h3 style="color:#0d6efd;">å¿«æ·éµå·¥ä½œæµï¼š</h3>
            <p>1. é»æ“Šç°è‰² <strong>ã€Œç·¨è¼¯åˆ†é¡ã€</strong> æŒ‰éˆ•ä¾†è¨­å®šã€‚</p>
            <p>2. <strong>å·¦æ‰‹</strong> æ“ä½œéµç›¤ç†±éµ (ä¾‹å¦‚ 1, 2, Q, W)ã€‚</p>
            <p>3. <strong>å³æ‰‹</strong> æŒ‰ Enter æ›ä¸‹ä¸€å¼µã€‚</p>
        </div>
        <div style="background:#f8f9fa; padding:15px; border-radius:8px; border-left:4px solid #fd7e14;">
            <h4 style="margin:0 0 10px 0;">æª”åè¦å‰‡ï¼š</h4>
            <p><strong>è‡ªå‹•æµæ°´è™Ÿï¼š</strong> é»é¸ã€Œè»Šä½ã€ â” å­˜ç‚º <code>è»Šä½\è»Šä½_001.jpg</code></p>
            <p><strong>è‡ªè¨‚åç¨±ï¼š</strong> é—œé–‰é–‹é—œï¼Œè¼¸å…¥ã€Œç ´æã€ â” å­˜ç‚º <code>è»Šä½\è»Šä½_ç ´æ.jpg</code></p>
        </div>
    </div>
</div>

<script>
    let files = [], fileData = [], currentIndex = 0;
    let keyMap = {}; 
    
    // é è¨­åˆ†é¡è³‡æ–™ (åˆ†é¡å, æŒ‰éµ)
    let categories = [
        { name: "è»Šä½", key: "1" },
        { name: "æˆ¿å­", key: "2" },
        { name: "çª—æˆ¶", key: "Q" },
        { name: "é™½å°", key: "W" },
        { name: "å¤§é–€", key: "E" }
    ];

    const UI = {
        folderInput: document.getElementById('folderInput'),
        img: document.getElementById('currentImage'),
        placeholder: document.getElementById('placeholder'),
        fileName: document.getElementById('fileName'),
        progress: document.getElementById('progress'),
        catContainer: document.getElementById('categoryContainer'),
        autoSeqCheck: document.getElementById('autoSeqCheck'),
        customInput: document.getElementById('customInput'),
        errorMsg: document.getElementById('errorMsg'),
        finalPreview: document.getElementById('finalPreview')
    };

    // åˆå§‹åŒ–
    renderCategories();

    // --- è¨­å®šè¦–çª—é‚è¼¯ ---
    function openSettings() {
        const body = document.getElementById('settingsBody');
        body.innerHTML = '';
        
        categories.forEach(cat => {
            addSettingRow(cat.name, cat.key);
        });
        
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function addSettingRow(name = "", key = "") {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="settings-input name-field" value="${name}" placeholder="åˆ†é¡åç¨±"></td>
            <td><input type="text" class="settings-input key-input" value="${key}" maxlength="1" placeholder="-"></td>
            <td class="del-btn" onclick="this.parentElement.remove()">âœ–</td>
        `;
        document.getElementById('settingsBody').appendChild(tr);
    }

    function saveSettings() {
        const rows = document.querySelectorAll('#settingsBody tr');
        const newCats = [];
        
        rows.forEach(row => {
            const name = row.querySelector('.name-field').value.trim();
            const key = row.querySelector('.key-input').value.trim().toUpperCase();
            if (name) {
                newCats.push({ name, key });
            }
        });

        categories = newCats;
        renderCategories(); // é‡æ–°æ¸²æŸ“ä¸»ç•«é¢æŒ‰éˆ•
        closeSettings();
        updatePreview();
    }

    // --- ä¸»ç•«é¢æ¸²æŸ“ ---
    function renderCategories() {
        UI.catContainer.innerHTML = '';
        keyMap = {}; 
        const currentSelected = getSelectedCategory();

        categories.forEach(cat => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            btn.dataset.val = cat.name;
            
            if (cat.key) {
                btn.innerHTML = `<span class="key-badge">${cat.key}</span>${cat.name}`;
                keyMap[cat.key.toLowerCase()] = cat.name;
            } else {
                btn.textContent = cat.name;
            }

            if (cat.name === currentSelected) btn.classList.add('active');
            
            btn.onclick = () => selectCategory(cat.name);
            UI.catContainer.appendChild(btn);
        });
    }

    function selectCategory(catName) {
        document.querySelectorAll('.cat-btn').forEach(b => {
            b.classList.remove('active');
            if (b.dataset.val === catName) b.classList.add('active');
        });
        updatePreview();
    }

    function getSelectedCategory() {
        const activeBtn = document.querySelector('.cat-btn.active');
        return activeBtn ? activeBtn.dataset.val : null;
    }

    // --- éµç›¤ç›£è½ ---
    document.addEventListener('keydown', (e) => {
        if (document.activeElement === UI.customInput || document.querySelector('.settings-input:focus')) {
            if (e.key === "Enter" && document.activeElement === UI.customInput) nextImage();
            return;
        }

        if (document.getElementById('settingsModal').style.display === 'flex') return;
        if (!files.length) return;

        if (e.key === "Enter") { nextImage(); return; }
        if (e.key === "ArrowRight") { nextImage(); return; }
        if (e.key === "ArrowLeft") { prevImage(); return; }

        const pressedKey = e.key.toLowerCase();
        if (keyMap[pressedKey]) {
            selectCategory(keyMap[pressedKey]);
            // æŒ‰éˆ•è¦–è¦ºå›é¥‹
            const btn = Array.from(document.querySelectorAll('.cat-btn')).find(b => b.dataset.val === keyMap[pressedKey]);
            if(btn) {
                btn.style.transform = "scale(0.95)";
                setTimeout(()=>btn.style.transform="scale(1)", 100);
            }
        }
    });

    // --- å‘½åèˆ‡æª”æ¡ˆè™•ç† (ç¶­æŒåŸé‚è¼¯) ---
    function toggleNamingMode() {
        const isAuto = UI.autoSeqCheck.checked;
        UI.customInput.disabled = isAuto;
        if (isAuto) {
            UI.customInput.value = '';
            UI.customInput.placeholder = "ä½¿ç”¨æµæ°´è™Ÿä¸­...";
            UI.errorMsg.style.display = 'none';
        } else {
            UI.customInput.placeholder = "è¼¸å…¥è‡ªè¨‚åç¨±...";
            UI.customInput.focus();
        }
        updatePreview();
    }

    function validateInput(input) {
        const clean = input.value.replace(/[\\/:*?"<>|]/g, '');
        if (input.value !== clean) {
            input.value = clean;
            UI.errorMsg.style.display = 'block';
        } else {
            UI.errorMsg.style.display = 'none';
        }
        updatePreview();
    }

    function updatePreview() {
        if (!files.length) return;
        const category = getSelectedCategory();
        const ext = files[currentIndex].name.split('.').pop();
        
        if (!category) {
            UI.finalPreview.textContent = "é è¦½: è«‹é¸æ“‡åˆ†é¡";
            UI.finalPreview.style.color = "#dc3545";
            return;
        }

        UI.finalPreview.style.color = "#333";
        if (UI.autoSeqCheck.checked) {
            UI.finalPreview.textContent = `å­˜æª”ç‚º: ${category}\\${category}_001.${ext}`;
        } else {
            const custom = UI.customInput.value.trim();
            UI.finalPreview.textContent = `å­˜æª”ç‚º: ${category}\\${category}_${custom || 'åç¨±'}.${ext}`;
        }
    }

    UI.folderInput.addEventListener('change', function(e) {
        files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
        if (files.length === 0) { alert("æ²’æœ‰åœ–ç‰‡ï¼"); return; }
        
        fileData = files.map(f => ({ originalName: f.name, category: null, isAuto: true, customText: "" }));
        
        const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
        files.sort((a, b) => collator.compare(a.name, b.name));
        fileData.sort((a, b) => collator.compare(a.originalName, b.originalName));

        currentIndex = 0;
        loadUI();
    });

    function loadUI() {
        if (!files.length) return;
        if (UI.img.src) URL.revokeObjectURL(UI.img.src);

        UI.img.src = URL.createObjectURL(files[currentIndex]);
        UI.img.style.display = 'block';
        UI.placeholder.style.display = 'none';
        UI.fileName.textContent = files[currentIndex].name;
        UI.progress.textContent = `${currentIndex + 1} / ${files.length}`;
        
        const data = fileData[currentIndex];
        selectCategory(data.category);

        UI.autoSeqCheck.checked = data.isAuto;
        UI.customInput.value = data.customText;
        toggleNamingMode();
    }

    function saveCurrent() {
        if (!files.length) return true;
        const category = getSelectedCategory();
        if (!category) { alert("âš ï¸ è«‹å…ˆé¸æ“‡åˆ†é¡ï¼"); return false; }
        if (!UI.autoSeqCheck.checked && !UI.customInput.value.trim()) {
            alert("âš ï¸ è«‹è¼¸å…¥è‡ªè¨‚åç¨±ï¼");
            UI.customInput.focus();
            return false;
        }
        fileData[currentIndex].category = category;
        fileData[currentIndex].isAuto = UI.autoSeqCheck.checked;
        fileData[currentIndex].customText = UI.customInput.value.trim();
        return true;
    }
    
    function nextImage() {
        if (!saveCurrent()) return;
        if (currentIndex < files.length - 1) { currentIndex++; loadUI(); }
        else { alert("ğŸ‰ å·²å®Œæˆæ‰€æœ‰ç…§ç‰‡ï¼"); }
    }
    
    function prevImage() {
        if(files.length && getSelectedCategory()) saveCurrent();
        if (currentIndex > 0) { currentIndex--; loadUI(); }
    }

    function checkEnter(e) { if (e.key === "Enter") nextImage(); }
    
    function showHelp() {
        const modal = document.getElementById('helpModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    function exportBat() {
        if (!files.length) return;
        if (!saveCurrent()) return;

        let batContent = "@echo off\r\nchcp 65001 >nul\r\necho æ­£åœ¨æ•´ç†ç…§ç‰‡...\r\n\r\n";
        
        let folders = new Set();
        fileData.forEach(d => { if(d.category) folders.add(d.category); });
        folders.forEach(f => { batContent += `if not exist "${f}" md "${f}"\r\n`; });
        batContent += "\r\n";

        let counts = {};
        fileData.forEach(item => {
            if (!item.category) return;
            const ext = item.originalName.split('.').pop();
            let finalName = "";

            if (item.isAuto) {
                if (!counts[item.category]) counts[item.category] = 0;
                counts[item.category]++;
                let seq = String(counts[item.category]).padStart(3, '0');
                finalName = `${item.category}_${seq}.${ext}`;
            } else {
                finalName = `${item.category}_${item.customText}.${ext}`;
            }
            batContent += `move "${item.originalName}" "${item.category}\\${finalName}"\r\n`;
        });

        batContent += `\r\necho æ•´ç†å®Œæˆï¼\r\npause`;
        
        const blob = new Blob([batContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "é–‹å§‹æ•´ç†.bat";
        link.click();
    }
</script>
</body>
</html>
