<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ¨™è¨»å·¥å…· (BATè‡ªå‹•æ”¹åç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .header { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        
        .config-area { background: #eef2f7; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #d1d9e6; }
        .config-area summary { cursor: pointer; font-weight: bold; color: #0056b3; outline: none; }
        textarea { width: 100%; height: 80px; padding: 10px; margin-top:10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}

        .viewer { display: flex; gap: 20px; min-height: 500px; }
        .image-box { flex: 2; background: #222; display: flex; align-items: center; justify-content: center; border-radius: 6px; overflow: hidden; }
        .image-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .controls { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .info-panel { background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #17a2b8; font-size: 0.9em; }
        
        #quickTags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 5px; }
        .tag-btn { background: #e2e6ea; border: 1px solid #ced4da; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .tag-btn:hover { background: #dbeaff; border-color: #b8daff; color: #0056b3; }

        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        input[type="text"]:focus { border-color: #007bff; outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: auto; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 15px; font-weight: bold; }
        .btn-primary { background: #007bff; color: white; flex: 1; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-clear { background: #dc3545; color: white; padding: 5px 10px; font-size: 12px; margin-left: auto; }
        
        /* æ”¹ç”¨æ©˜è‰²å‡¸é¡¯ä¸‹è¼‰æŒ‰éˆ• */
        .btn-download { background: #fd7e14; color: white; width: 100%; padding: 15px; font-size: 18px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s; }
        .btn-download:hover { background: #e96b02; transform: translateY(-2px); }

        .upload-btn { background: #17a2b8; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; display: inline-block; font-weight: bold; }
        #folderInput { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;">ğŸ“· ç…§ç‰‡æ¨™è¨»å·¥å…· (BATç‰ˆ)</h2>
            <label for="folderInput" class="upload-btn">ğŸ“‚ é¸æ“‡ç…§ç‰‡è³‡æ–™å¤¾</label>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>

        <details class="config-area" open>
            <summary>âš™ï¸ è¨­å®šæ¨™ç±¤ (ä¸­æ–‡,ä»£ç¢¼)</summary>
            <textarea id="tagConfig" placeholder="æ ¼å¼ï¼šä¸­æ–‡åç¨±,è‹±æ–‡ä»£ç¢¼" oninput="renderQuickTags()">
å°åŒ—å±•è¦½,TPE_Expo
é«˜é›„å‡ºå·®,KHH_Trip
å“¡å·¥èšé¤,Dinner
ç”¢å“æ¸¬è©¦,Test
            </textarea>
        </details>
    </div>

    <div class="viewer">
        <div class="image-box">
            <img id="currentImage" src="" alt="" style="display:none;">
            <div id="placeholder" style="color:#aaa;">è«‹é»æ“Šå³ä¸Šæ–¹é¸æ“‡è³‡æ–™å¤¾é–‹å§‹</div>
        </div>

        <div class="controls">
            <div class="info-panel">
                <div>åŸå§‹æª”å: <strong id="fileName">-</strong></div>
                <div style="margin-top:5px; color:#666;">é€²åº¦: <span id="progress">0 / 0</span></div>
            </div>

            <div>
                <label style="font-weight:bold; margin-bottom:8px; display:block;">å¿«é€Ÿæ¨™ç±¤:</label>
                <div id="quickTags"></div>
            </div>

            <div>
                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:5px;">
                    <label style="font-weight:bold;">æ–°æª”åä»£ç¢¼:</label>
                    <button class="btn-clear" onclick="clearInput()">æ¸…é™¤</button>
                </div>
                <input type="text" id="newTag" placeholder="è¼¸å…¥ä»£ç¢¼..." onkeydown="checkEnter(event)" oninput="validateInput(this)">
            </div>

            <div class="btn-group">
                <button class="btn-secondary" onclick="prevImage()">ä¸Šä¸€å¼µ (â†)</button>
                <button class="btn-primary" onclick="nextImage()">ä¸‹ä¸€å¼µ / æš«å­˜ (Enter)</button>
            </div>
            
            <button class="btn-download" onclick="exportBat()">âš¡ ä¸‹è¼‰è‡ªå‹•æ”¹ååŸ·è¡Œæª” (.bat)</button>
        </div>
    </div>
</div>

<script>
    let files = [], fileData = [], currentIndex = 0;
    const folderInput = document.getElementById('folderInput');
    const imgElement = document.getElementById('currentImage');
    const placeholder = document.getElementById('placeholder');
    const fileNameDisplay = document.getElementById('fileName');
    const progressDisplay = document.getElementById('progress');
    const tagInput = document.getElementById('newTag');
    const tagConfig = document.getElementById('tagConfig');
    const quickTagsContainer = document.getElementById('quickTags');

    renderQuickTags();

    function renderQuickTags() {
        quickTagsContainer.innerHTML = '';
        const lines = tagConfig.value.trim().split('\n');
        lines.forEach(line => {
            const parts = line.split(/[,ï¼Œ]/);
            if (parts.length >= 2) {
                const label = parts[0].trim();
                const code = parts[1].trim();
                if (label && code) {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn';
                    btn.textContent = `${label} (${code})`;
                    btn.onclick = () => addTag(code);
                    quickTagsContainer.appendChild(btn);
                }
            }
        });
    }

    function addTag(code) {
        const val = tagInput.value.trim();
        tagInput.value = val ? (val.endsWith(code) ? val : val + "_" + code) : code;
        tagInput.focus();
    }

    function clearInput() { tagInput.value = ""; tagInput.focus(); }

    // é˜²å‘†ï¼šç¦æ­¢éæ³•å­—å…ƒ
    function validateInput(input) {
        input.value = input.value.replace(/[\\/:*?"<>|]/g, '');
    }

    folderInput.addEventListener('change', function(e) {
        files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
        if (files.length === 0) { alert("æ²’æœ‰åœ–ç‰‡ï¼"); return; }
        
        fileData = files.map(f => ({ originalName: f.name, tag: "" }));
        const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
        files.sort((a, b) => collator.compare(a.name, b.name));
        fileData.sort((a, b) => collator.compare(a.originalName, b.originalName));

        currentIndex = 0;
        loadUI();
    });

    function loadUI() {
        if (!files.length) return;
        // é‡‹æ”¾è¨˜æ†¶é«”
        if (imgElement.src) URL.revokeObjectURL(imgElement.src);

        imgElement.src = URL.createObjectURL(files[currentIndex]);
        imgElement.style.display = 'block';
        placeholder.style.display = 'none';
        fileNameDisplay.textContent = files[currentIndex].name;
        progressDisplay.textContent = `${currentIndex + 1} / ${files.length}`;
        tagInput.value = fileData[currentIndex].tag;
        tagInput.focus();
    }

    function saveCurrent() { if (files.length) fileData[currentIndex].tag = tagInput.value.trim(); }
    
    function nextImage() {
        saveCurrent();
        if (currentIndex < files.length - 1) { currentIndex++; loadUI(); }
        else { alert("å·²æ˜¯æœ€å¾Œä¸€å¼µï¼Œå¯é»æ“Šä¸‹æ–¹æŒ‰éˆ•ä¸‹è¼‰åŸ·è¡Œæª”ã€‚"); }
    }
    
    function prevImage() {
        saveCurrent();
        if (currentIndex > 0) { currentIndex--; loadUI(); }
    }

    function checkEnter(e) { if (e.key === "Enter") nextImage(); }
    
    document.addEventListener('keydown', (e) => {
        if (document.activeElement !== tagInput && files.length) {
            if (e.key === "ArrowRight") nextImage();
            if (e.key === "ArrowLeft") prevImage();
        }
    });
    
    // é˜²æ­¢æœªä¸‹è¼‰å°±é›¢é–‹
    window.onbeforeunload = function() {
        if (files.length > 0) return "æ‚¨çš„è®Šæ›´å°šæœªä¸‹è¼‰ï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ";
    };

    // --- é‡é»ï¼šç”Ÿæˆ .bat æª” ---
    function exportBat() {
        if (!files.length) return;
        saveCurrent();

        // 1. å¯«å…¥æ‰¹æ¬¡æª”é–‹é ­ï¼šé—œé–‰å›é¡¯ï¼Œåˆ‡æ› UTF-8 ç·¨ç¢¼
        let batContent = "@echo off\r\n";
        batContent += "chcp 65001 >nul\r\n"; // åˆ‡æ›ä»£ç¢¼é åˆ° UTF-8ï¼Œä¸¦éš±è—æˆåŠŸè¨Šæ¯
        batContent += "echo æ­£åœ¨è™•ç†æ”¹åï¼Œè«‹ç¨å€™...\r\n\r\n";

        let renameCount = 0;

        // 2. è¿´åœˆç”Ÿæˆ rename æŒ‡ä»¤
        fileData.forEach(item => {
            // å¦‚æœæ²’æœ‰æ¨™ç±¤ï¼Œå°±ä¸æ”¹å
            if (!item.tag) return;

            let ext = item.originalName.split('.').pop();
            let newName = `${item.tag}.${ext}`;
            
            // å¦‚æœæ–°èˆŠæª”åä¸€æ¨£ï¼Œè·³é
            if (item.originalName === newName) return;

            // ç”ŸæˆæŒ‡ä»¤ï¼šren "èˆŠå" "æ–°å"
            // ä½¿ç”¨é›™å¼•è™ŸåŒ…ä½æª”åï¼Œé˜²æ­¢æª”åä¸­æœ‰ç©ºæ ¼å°è‡´éŒ¯èª¤
            batContent += `ren "${item.originalName}" "${newName}"\r\n`;
            renameCount++;
        });

        // 3. çµå°¾ï¼šé¡¯ç¤ºå®Œæˆè¨Šæ¯ä¸¦æš«åœ
        batContent += `\r\necho.\r\necho ------------------------------\r\n`;
        batContent += `echo è™•ç†å®Œæˆï¼å…±å˜—è©¦ä¿®æ”¹ ${renameCount} å€‹æª”æ¡ˆã€‚\r\n`;
        batContent += `echo å¦‚æœçœ‹åˆ°ã€Œç³»çµ±æ‰¾ä¸åˆ°æŒ‡å®šçš„æª”æ¡ˆã€æˆ–ã€Œæª”åé‡è¤‡ã€ï¼Œè«‹æª¢æŸ¥è³‡æ–™å¤¾å…§å®¹ã€‚\r\n`;
        batContent += `echo ------------------------------\r\n`;
        batContent += `pause`;

        // 4. ä¸‹è¼‰æª”æ¡ˆ
        const blob = new Blob([batContent], { type: 'text/plain;charset=utf-8' }); // æ”¹ç”¨ text/plain é¿å…ç€è¦½å™¨éåº¦è­¦å‘Š
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "é–‹å§‹æ”¹å.bat"; // æŒ‡å®šå‰¯æª”å
        link.click();
    }
</script>
</body>
</html>
