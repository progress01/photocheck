<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ¨™è¨»å°å·¥å…· (è‡ªè¨‚æ¨™ç±¤ç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* é ‚éƒ¨è¨­å®šå€ */
        .header { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .config-area { background: #eef2f7; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #d1d9e6; }
        .config-area summary { cursor: pointer; font-weight: bold; color: #0056b3; outline: none; }
        .config-content { margin-top: 10px; display: flex; gap: 15px; }
        textarea { flex: 1; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: monospace; resize: vertical; }
        .config-help { flex: 1; font-size: 0.9em; color: #666; line-height: 1.6; }

        /* ä¸»è¦–çª—ä½ˆå±€ */
        .viewer { display: flex; gap: 20px; min-height: 500px; }
        
        /* å·¦å´åœ–ç‰‡å€ */
        .image-box { flex: 2; background: #222; display: flex; align-items: center; justify-content: center; border-radius: 6px; overflow: hidden; position: relative; }
        .image-box img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* å³å´æ§åˆ¶å€ */
        .controls { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .info-panel { background: #f8f9fa; padding: 12px; border-radius: 6px; border-left: 4px solid #17a2b8; font-size: 0.9em; }
        
        /* å¿«é€Ÿæ¨™ç±¤å€ */
        #quickTags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 5px; }
        .tag-btn { background: #e2e6ea; border: 1px solid #ced4da; padding: 6px 12px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .tag-btn:hover { background: #dbeaff; border-color: #b8daff; color: #0056b3; transform: translateY(-1px); }
        .tag-code { font-size: 0.85em; color: #888; margin-left: 4px; }

        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input[type="text"]:focus { border-color: #007bff; outline: none; }
        
        .btn-group { display: flex; gap: 10px; margin-top: auto; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-size: 15px; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; flex: 1; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-clear { background: #dc3545; color: white; padding: 5px 10px; font-size: 12px; margin-left: auto; display: block; width: fit-content; margin-bottom: 5px;}
        .btn-success { background: #28a745; color: white; width: 100%; padding: 15px; font-size: 18px; margin-top: 10px; }
        .btn-success:hover { background: #218838; }

        .upload-btn { background: #17a2b8; color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; display: inline-block; font-weight: bold; }
        .upload-btn:hover { background: #138496; }
        #folderInput { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0;">ğŸ“· ç…§ç‰‡æ¨™è¨»èˆ‡æ”¹åå·¥å…·</h2>
            <label for="folderInput" class="upload-btn">ğŸ“‚ 1. é¸æ“‡ç…§ç‰‡è³‡æ–™å¤¾</label>
            <input type="file" id="folderInput" webkitdirectory directory multiple>
        </div>

        <details class="config-area" open>
            <summary>âš™ï¸ æŒ‰æ­¤è¨­å®šï¼šä¸­æ–‡æ¨™ç±¤èˆ‡æª”æ¡ˆä»£ç¢¼å°ç…§è¡¨</summary>
            <div class="config-content">
                <textarea id="tagConfig" placeholder="æ ¼å¼ï¼šä¸­æ–‡åç¨±,è‹±æ–‡ä»£ç¢¼ (ä¸€è¡Œä¸€å€‹)" oninput="renderQuickTags()">
å°åŒ—å±•è¦½,TPE_Expo
é«˜é›„å‡ºå·®,KHH_Trip
å“¡å·¥èšé¤,Dinner
ç”¢å“æ¸¬è©¦,Test
                </textarea>
                <div class="config-help">
                    <strong>å¦‚ä½•è¨­å®šï¼š</strong><br>
                    è«‹åœ¨å·¦å´è¼¸å…¥æ‚¨æƒ³è¦çš„å°æ‡‰ï¼Œæ ¼å¼ç‚ºã€Œä¸­æ–‡,è‹±æ–‡ã€ï¼Œä¸€è¡Œä¸€å€‹ã€‚<br>
                    ä¾‹å¦‚ï¼š<br>
                    <code>æœƒè­°è¨˜éŒ„,Meeting</code><br>
                    <code>æˆ¶å¤–æ•™å­¸,Outdoor</code><br>
                    <br>
                    è¼¸å…¥å¾Œï¼Œä¸‹æ–¹æœƒè‡ªå‹•ç”¢ç”ŸæŒ‰éˆ•ã€‚
                </div>
            </div>
        </details>
    </div>

    <div class="viewer">
        <div class="image-box">
            <img id="currentImage" src="" alt="" style="display:none;">
            <div id="placeholder" style="color:#aaa;">è«‹é»æ“Šå³ä¸Šæ–¹é¸æ“‡è³‡æ–™å¤¾é–‹å§‹</div>
        </div>

        <div class="controls">
            <div class="info-panel">
                <div style="margin-bottom:5px; color:#555;">åŸå§‹æª”å</div>
                <strong id="fileName" style="font-size:1.1em; word-break: break-all;">-</strong>
                <div style="margin-top:5px; font-size:0.85em; color:#888;">é€²åº¦: <span id="progress">0 / 0</span></div>
            </div>

            <div>
                <label style="font-weight:bold; margin-bottom:8px; display:block;">å¿«é€Ÿæ¨™ç±¤ (é»æ“ŠåŠ å…¥):</label>
                <div id="quickTags"></div>
            </div>

            <div style="margin-top: 10px;">
                <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:5px;">
                    <label for="newTag" style="font-weight:bold;">æ–°æª”åä»£ç¢¼:</label>
                    <button class="btn-clear" onclick="clearInput()">æ¸…é™¤é‡å¡«</button>
                </div>
                <input type="text" id="newTag" placeholder="é»æ“Šä¸Šæ–¹æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥..." onkeydown="checkEnter(event)">
                <div style="font-size:0.8em; color:#888; margin-top:5px;">* è‹¥æœ‰å¤šå€‹æ¨™ç±¤ï¼Œç³»çµ±æœƒè‡ªå‹•ç”¨åº•ç·š "_" é€£æ¥</div>
            </div>

            <div class="btn-group">
                <button class="btn-secondary" onclick="prevImage()">ä¸Šä¸€å¼µ (â†)</button>
                <button class="btn-primary" onclick="nextImage()">ä¸‹ä¸€å¼µ / å„²å­˜ (Enter)</button>
            </div>
            
            <hr style="width:100%; border:0; border-top:1px solid #eee; margin: 20px 0;">
            <button class="btn-success" onclick="exportCSV()">ğŸ“¥ ä¸‹è¼‰ CSV æ”¹åæ¸…å–®</button>
        </div>
    </div>
</div>

<script>
    let files = [];
    let fileData = []; 
    let currentIndex = 0;

    const folderInput = document.getElementById('folderInput');
    const imgElement = document.getElementById('currentImage');
    const placeholder = document.getElementById('placeholder');
    const fileNameDisplay = document.getElementById('fileName');
    const progressDisplay = document.getElementById('progress');
    const tagInput = document.getElementById('newTag');
    const tagConfig = document.getElementById('tagConfig');
    const quickTagsContainer = document.getElementById('quickTags');

    // åˆå§‹åŒ–ï¼šç”¢ç”Ÿé è¨­æ¨™ç±¤æŒ‰éˆ•
    renderQuickTags();

    // 1. ç”¢ç”Ÿå¿«é€Ÿæ¨™ç±¤æŒ‰éˆ•é‚è¼¯
    function renderQuickTags() {
        quickTagsContainer.innerHTML = '';
        const configText = tagConfig.value.trim();
        const lines = configText.split('\n');

        lines.forEach(line => {
            // ç°¡å–®è™•ç†é€—è™Ÿåˆ†éš”ï¼Œä¸¦ç§»é™¤å¤šé¤˜ç©ºç™½
            const parts = line.split(/[,ï¼Œ]/); // æ”¯æ´å…¨å½¢å’ŒåŠå½¢é€—è™Ÿ
            if (parts.length >= 2) {
                const label = parts[0].trim();
                const code = parts[1].trim();

                if (label && code) {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn';
                    btn.innerHTML = `${label} <span class="tag-code">${code}</span>`;
                    btn.onclick = () => addTag(code);
                    quickTagsContainer.appendChild(btn);
                }
            }
        });
    }

    // 2. é»æ“ŠæŒ‰éˆ•åŠ å…¥æ¨™ç±¤
    function addTag(code) {
        const currentVal = tagInput.value.trim();
        if (currentVal === "") {
            tagInput.value = code;
        } else {
            // å¦‚æœå·²ç¶“æœ‰å…§å®¹ï¼Œç”¨åº•ç·šé€£æ¥ (ä¾‹å¦‚: Meeting_2023)
            // é˜²æ­¢é‡è¤‡åŠ å…¥ä¸€æ¨£çš„å°¾ç¶´
            if (!currentVal.endsWith(code)) {
                tagInput.value = currentVal + "_" + code;
            }
        }
        tagInput.focus();
    }

    function clearInput() {
        tagInput.value = "";
        tagInput.focus();
    }

    // 3. è®€å–è³‡æ–™å¤¾
    folderInput.addEventListener('change', function(e) {
        const allFiles = Array.from(e.target.files);
        files = allFiles.filter(f => f.type.startsWith('image/'));
        
        if (files.length === 0) {
            alert("æ­¤è³‡æ–™å¤¾å…§æ²’æœ‰åœ–ç‰‡ï¼");
            return;
        }

        // åˆå§‹åŒ–è³‡æ–™
        fileData = files.map(f => ({
            originalName: f.name,
            tag: ""
        }));

        // æ’åº (Windows æª”æ¡ˆç¸½ç®¡é‚è¼¯æ’åº)
        const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
        files.sort((a, b) => collator.compare(a.name, b.name));
        fileData.sort((a, b) => collator.compare(a.originalName, b.originalName));

        currentIndex = 0;
        loadUI();
    });

    // 4. è¼‰å…¥ä»‹é¢
    function loadUI() {
        if (files.length === 0) return;

        const currentFile = files[currentIndex];
        const currentData = fileData[currentIndex];

        imgElement.src = URL.createObjectURL(currentFile);
        imgElement.style.display = 'block';
        placeholder.style.display = 'none';

        fileNameDisplay.textContent = currentFile.name;
        progressDisplay.textContent = `${currentIndex + 1} / ${files.length}`;
        tagInput.value = currentData.tag;
        tagInput.focus();
    }

    // 5. å„²å­˜èˆ‡å°èˆª
    function saveCurrent() {
        if (files.length === 0) return;
        fileData[currentIndex].tag = tagInput.value.trim();
    }

    function nextImage() {
        if (files.length === 0) return;
        saveCurrent();
        
        if (currentIndex < files.length - 1) {
            currentIndex++;
            loadUI();
        } else {
            // æœ€å¾Œä¸€å¼µæ™‚çš„æç¤ºï¼Œç¨å¾®å‹å–„ä¸€é»
            if(confirm("å·²ç¶“æ˜¯æœ€å¾Œä¸€å¼µäº†ï¼Œè¦ä¸‹è¼‰ CSV æª”äº†å—ï¼Ÿ")) {
                exportCSV();
            }
        }
    }

    function prevImage() {
        if (files.length === 0) return;
        saveCurrent();
        if (currentIndex > 0) {
            currentIndex--;
            loadUI();
        }
    }
    
    // éµç›¤æ“ä½œæ”¯æ´
    function checkEnter(event) {
        if (event.key === "Enter") {
            nextImage();
        }
    }
    
    // ç›£è½å·¦å³æ–¹å‘éµ
    document.addEventListener('keydown', function(event) {
        // åªæœ‰åœ¨è¼¸å…¥æ¡†æ²’æœ‰ focus æ™‚ï¼Œæ‰å•Ÿç”¨å·¦å³éµæ›é ï¼Œé¿å…æ‰“å­—æ™‚èª¤è§¸
        if (document.activeElement !== tagInput && files.length > 0) {
            if (event.key === "ArrowRight") nextImage();
            if (event.key === "ArrowLeft") prevImage();
        }
    });

    // 6. åŒ¯å‡º CSV
    function exportCSV() {
        if (files.length === 0) {
            alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
            return;
        }
        saveCurrent();

        let csvContent = "\uFEFF"; 
        csvContent += "åŸå§‹æª”å,æ¨™è¨»ä»£ç¢¼,å»ºè­°æ–°æª”å\n";

        fileData.forEach(item => {
            let extension = item.originalName.split('.').pop();
            // å¦‚æœæ²’æœ‰æ¨™ç±¤ï¼Œå°±ä¿æŒåŸæª”åï¼›å¦‚æœæœ‰ï¼Œå‰‡æ”¹ç‚º æ¨™ç±¤.å‰¯æª”å
            let newName = item.tag ? `${item.tag}.${extension}` : item.originalName;
            
            // è™•ç† CSV ç‰¹æ®Šå­—å…ƒ
            let safeTag = item.tag.includes(',') ? `"${item.tag}"` : item.tag;
            
            csvContent += `${item.originalName},${safeTag},${newName}\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "rename_list.csv");
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>

</body>
</html>
