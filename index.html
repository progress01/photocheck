<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç…§ç‰‡æ­¸æª”ç¥å™¨ v8.0 (æ¥µç°¡åƒç…§ç‰ˆ)</title>
    <style>
        :root { --primary: #0d6efd; --purple: #6610f2; --success: #198754; --warning: #ffc107; --danger: #dc3545; --bg: #f8f9fa; --overlay-bg: rgba(0,0,0,0.85); }
        body { font-family: "Microsoft JhengHei", "Segoe UI", sans-serif; margin: 0; padding: 20px; background: var(--bg); color: #333; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å°èˆªåˆ— */
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 50; }
        .nav-title { margin: 0; font-size: 1.2rem; font-weight: bold; }

        .main-layout { display: grid; grid-template-columns: 1fr 420px; gap: 20px; flex: 1; min-height: 0; position: relative; }
        
        /* åœ–ç‰‡å€ */
        .image-panel { background: #222; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* åœ–ç‰‡å®¹å™¨èˆ‡æ¨¡å¼ */
        .image-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; position: relative; }
        .image-container img { transition: transform 0.2s ease; display: none; transform-origin: center center; }
        
        /* é¡¯ç¤ºæ¨¡å¼ (CSS Class) */
        .view-fit img { max-width: 95%; max-height: 95%; object-fit: contain; } /* ç•™ä¸€é»é‚Š */
        .view-fill img { width: 100%; height: 100%; object-fit: cover; }
        .view-small img { max-width: 60%; max-height: 60%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .view-1to1 { overflow: auto; align-items: flex-start; justify-content: flex-start; cursor: grab; }
        .view-1to1 img { max-width: none; max-height: none; width: auto; height: auto; }
        .view-1to1:active { cursor: grabbing; }

        /* è¦–åœ–åˆ‡æ›æŒ‰éˆ• */
        .view-controls { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 30; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 20px; backdrop-filter: blur(4px); }
        .view-btn { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 12px; font-size: 12px; cursor: pointer; border-radius: 15px; transition: 0.2s; }
        .view-btn:hover { background: rgba(255,255,255,0.2); }
        .view-btn.active { background: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* è³‡è¨Šå„€è¡¨æ¿ */
        .info-bar { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: rgba(0,0,0,0.7); color: white; 
            padding: 8px 15px; box-sizing: border-box; 
            display: flex; justify-content: space-between; font-size: 14px; font-family: monospace;
            backdrop-filter: blur(2px); z-index: 20;
        }

        /* é è¨­ä½”ä½ */
        .placeholder-content { text-align: center; color: #666; }
        .placeholder-icon { font-size: 5rem; margin-bottom: 10px; opacity: 0.3; }
        
        /* ç‹€æ…‹é®ç½© */
        .status-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; color: #ff6b6b; font-size: 4rem; font-weight: bold; z-index: 10; flex-direction: column; pointer-events: none; }
        
        /* å´é‚Šæ¬„ */
        .sidebar { background: white; border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-header { border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 8px; font-weight: bold; color: #555; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        
        /* å·¥å…·åˆ— */
        .toolbar { display: flex; gap: 8px; margin-bottom: 5px; }
        .tool-btn { flex: 1; padding: 8px; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .tool-btn:hover { background: #f0f0f0; }
        .tool-btn.active { background: #e7f5ff; border-color: var(--primary); color: var(--primary); font-weight: bold; }

        /* åˆ†é¡æŒ‰éˆ• */
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
        .cat-btn, .tag-btn { 
            background: white; border: 1px solid #ccc; padding: 10px 5px; border-radius: 6px; 
            cursor: pointer; font-size: 14px; text-align: center; transition: 0.2s; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 45px; user-select: none;
        }
        .cat-btn:hover, .tag-btn:hover { background: #f8f9fa; border-color: #999; }
        .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: bold; transform: scale(0.98); box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3); }
        .tag-btn.active { background: var(--purple); color: white; border-color: var(--purple); font-weight: bold; transform: scale(0.98); box-shadow: 0 2px 5px rgba(102, 16, 242, 0.3); }
        .key-badge { position: absolute; top: 2px; right: 2px; background: #333; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; opacity: 0.8; font-family: monospace; }
        .cat-btn.active .key-badge, .tag-btn.active .key-badge { background: white; color: #333; }

        /* å‘½åæ§åˆ¶å€ */
        .naming-control { border: 2px solid #eee; padding: 15px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; cursor: pointer; user-select: none; }
        
        /* é–‹é—œæ¨£å¼ */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(18px); }
        
        .input-wrapper { position: relative; }
        .custom-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 15px; box-sizing: border-box; background: #fff; transition:0.3s; }
        .custom-input:disabled { background: #e9ecef; color: #aaa; cursor: not-allowed; border-color: #eee; }
        .custom-input:focus { border-color: var(--primary); outline: none; }
        .num-input { width:80px; padding:5px; text-align:center; border:1px solid #ccc; border-radius:4px; margin-left:10px; }

        /* é è¦½èˆ‡å°èˆªå€ */
        .preview-box { background: #e9ecef; padding: 12px; border-radius: 6px; text-align: right; font-family: monospace; font-size: 0.95rem; color: #555; margin-top: auto; border: 1px solid #dee2e6; }
        
        /* å°èˆªæŒ‰éˆ• */
        .nav-btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .nav-btn { flex: 1; padding: 12px; font-size: 15px; border: 1px solid #ccc; background: white; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn-primary { flex: 1.5; background: var(--primary); color: white; border: none; }
        .nav-btn-primary:hover { background: #0b5ed7; }

        /* ä¸‹è¼‰æŒ‰éˆ•ç¾¤ */
        .btn-download { background: #fd7e14; color: white; width: 100%; padding: 15px; font-size: 15px; border: none; border-radius: 6px; cursor: not-allowed; font-weight: bold; opacity: 0.5; transition:0.3s; pointer-events: none; margin-top: 5px; }
        .btn-download.active { cursor: pointer; opacity: 1; pointer-events: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-download.active:hover { transform: translateY(-2px); }
        #reportBtn.active:hover { background: #146c43; }
        #downloadBtn.active:hover { background: #e96b02; }

        /* ä¸Šæ–¹æŒ‰éˆ• */
        .btn-help { background: var(--purple); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-upload { background: var(--success); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 15px; transition:0.2s; }
        .btn-upload:hover { background: #157347; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

        /* æ­¡è¿èˆ‡å°è¦½ */
        .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; }
        .welcome-box { background: white; color: #333; padding: 40px; border-radius: 12px; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .start-btn { padding: 12px 30px; font-size: 1.1rem; background: var(--primary); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; margin: 10px; }
        .skip-btn { background: transparent; color: #666; border: 1px solid #ccc; padding: 10px 20px; border-radius: 50px; cursor: pointer; margin: 10px; }
        
        .spotlight { position: relative; z-index: 10000; box-shadow: 0 0 0 9999px var(--overlay-bg); background: white; pointer-events: none; border-radius: 6px; }
        .allow-click { pointer-events: auto !important; cursor: pointer; }
        .tour-tooltip { position: fixed; background: white; color: #333; padding: 20px; border-radius: 10px; width: 300px; z-index: 10003; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; }
        .tour-actions { display: flex; justify-content: flex-end; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; }
        .tour-skip-step { font-size: 12px; color: #999; background: none; border: none; cursor: pointer; text-decoration: underline; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 850px; height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .modal-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .tab-btn { flex: 1; padding: 15px; cursor: pointer; font-weight: bold; color: #666; text-align: center; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }
        .modal-body { padding: 30px; overflow-y: auto; flex: 1; display: none; }
        .modal-body.active { display: block; }

        /* è¨­å®šè¡¨æ ¼ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-col h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #555; }
        .settings-table { width: 100%; border-collapse: collapse; }
        .settings-table td { padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .settings-input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .key-input { width: 40px; text-align: center; text-transform: uppercase; font-weight: bold; }
        .add-btn { width: 100%; padding: 8px; margin-top: 10px; background: #f8f9fa; border: 1px dashed #ccc; cursor: pointer; }
        .save-btn { background: var(--primary); color: white; padding: 10px; border: none; border-radius: 6px; width: 100%; margin-top: 15px; font-weight: bold; cursor: pointer; }

        /* åŸç†åœ–è§£èˆ‡è­¦å‘Š */
        .bat-diagram { display: flex; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px dashed #ccc; text-align: center; font-size: 13px; }
        .bat-step { flex: 1; } .bat-icon { font-size: 1.8rem; display: block; }
        .win-alert { border: 1px solid #d9d9d9; background: white; margin: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-family: "Segoe UI", sans-serif; }
        .win-bar { background: #ffcc00; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .win-body { padding: 15px; font-size: 13px; color: #333; }
        
        .important-box { background:#fff3cd; border-left:5px solid #ffc107; padding:15px; margin-bottom:15px; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-title">ğŸ“· ç…§ç‰‡æ­¸æª”ç¥å™¨ <span style="font-size:0.8em; font-weight:normal;">v8.0</span></div>
    <div style="display:flex; gap:10px; align-items:center;">
        <button class="tool-btn" onclick="rotateImage()">âŸ³ è½‰å‘ (R)</button>
        <button class="btn-help" onclick="openHelpModal('tab1')">â“ æ•™å­¸</button>
        <label for="folderInput" id="uploadBtn" class="btn-upload" onclick="return checkUpload()"><span>ğŸ“‚ é¸æ“‡è³‡æ–™å¤¾</span></label>
        <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none;">
    </div>
</div>

<div class="main-layout">
    <div class="image-panel" id="imgPanel">
        <div class="view-controls" id="viewControls">
            <button class="view-btn active" onclick="changeView('fit')">å®Œæ•´ (Fit)</button>
            <button class="view-btn" onclick="changeView('small')">å°åœ– (Focus)</button>
            <button class="view-btn" onclick="changeView('1to1')">1:1</button>
        </div>

        <div class="image-container view-fit" id="imgContainer">
            <img id="currentImage" src="" alt="">
        </div>
        
        <div class="info-bar" id="infoBar" style="display:none;">
            <div id="infoFilename">ç­‰å¾…è¼‰å…¥...</div>
            <div id="infoProgress">0 / 0</div>
        </div>

        <div id="placeholder" class="placeholder-content">
            <div class="placeholder-icon">ğŸ“‚</div>
            <h3>ç­‰å¾…è¼‰å…¥ç…§ç‰‡</h3>
            <p>è«‹é»æ“Šå³ä¸Šè§’ã€Œé¸æ“‡è³‡æ–™å¤¾ã€é–‹å§‹</p>
        </div>
        <div class="status-overlay" id="trashOverlay"><div>ğŸ—‘ï¸</div><div style="font-size:1.5rem; color:white;">å·²ä¸Ÿå…¥å›æ”¶æ¡¶</div></div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="toolbar">
            <button class="tool-btn" onclick="openSettings()">âš™ï¸ è¨­å®šåˆ†é¡</button>
            <button class="tool-btn" id="lockBtn" onclick="toggleLock()">ğŸ”“ é–å®šåˆ†é¡</button>
        </div>

        <div id="catSection">
            <div class="section-header">ğŸ“‚ ä¸»åˆ†é¡ (è³‡æ–™å¤¾)</div>
            <div id="catContainer" class="btn-grid"></div>
        </div>

        <div id="tagSection">
            <div class="section-header">ğŸ·ï¸ å­æ¨™ç±¤ (å¾Œç¶´)</div>
            <div id="tagContainer" class="btn-grid"></div>
        </div>

        <div class="naming-control" id="namingSection">
            <div class="section-header" style="border:none; margin-bottom:5px;">âœï¸ å‘½åè¦å‰‡ (å¯è‡ªè¨‚)</div>
            <label class="toggle-row">
                <span style="font-size:14px; font-weight:bold; color:#555;">è‡ªå‹•æµæ°´è™Ÿ (_001)</span>
                <label class="switch">
                    <input type="checkbox" id="autoSeqCheck" checked onchange="toggleNamingMode()">
                    <span class="slider"></span>
                </label>
            </label>
            <div class="input-wrapper" style="display:flex; align-items:center;">
                <input type="text" id="customInput" class="custom-input" placeholder="è¼¸å…¥è‡ªè¨‚æª”å..." disabled oninput="onCustomInputChange(this)">
            </div>
            <div class="input-wrapper" style="margin-top:10px; display:flex; align-items:center; justify-content:space-between; font-size:14px; color:#555;">
                <span>ğŸ”¢ æµæ°´è™Ÿèµ·å§‹å€¼ï¼š</span>
                <input type="number" id="startSeqInput" class="num-input" value="1" min="1" onchange="updateUI()">
            </div>
            <div style="font-size:12px; color:#888; margin-top:5px;">* åˆ†æ‰¹è™•ç†æ™‚è«‹ä¿®æ”¹æ­¤æ•¸å€¼ (ä¾‹: 101) ä»¥å…æª”åè¡çª</div>
        </div>

        <div style="margin-top:auto;">
            <div class="preview-box" id="finalPreview">ç­‰å¾…æ“ä½œ...</div>
            
            <div class="nav-btn-group">
                <button class="nav-btn" onclick="prevImage()">â† ä¸Šä¸€å¼µ</button>
                <button class="nav-btn nav-btn-primary" onclick="nextImage()">ä¸‹ä¸€å¼µ (Enter)</button>
            </div>

            <div style="margin-top:10px;">
                <button id="reportBtn" class="btn-download" style="background:#198754;" onclick="exportReport()">ğŸ“„ ä¸‹è¼‰æª”æ¡ˆåƒç…§è¡¨ (.html)</button>
                <button id="downloadBtn" class="btn-download" onclick="exportBat()">âš¡ ä¸‹è¼‰æ•´ç†åŸ·è¡Œæª” (.bat)</button>
            </div>
        </div>
    </div>
</div>

<div id="welcomeOverlay" class="tour-overlay">
    <div class="welcome-box">
        <h1>ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h1>
        <p style="color:#666; margin-bottom:30px;">ç¬¬ä¸€æ¬¡ä½¿ç”¨å—ï¼Ÿå»ºè­°èŠ± 30 ç§’å®Œæˆæ–°æ‰‹å¼•å°ï¼Œç¢ºä¿æ“ä½œç„¡èª¤ã€‚</p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="skip-btn" onclick="skipTour()">è·³éæ•™å­¸</button>
            <button class="start-btn" onclick="startTour()">ğŸš€ é–‹å§‹æ–°æ‰‹å°å¼•</button>
        </div>
    </div>
</div>

<div id="tourTooltip" class="tour-tooltip">
    <span style="background:#0d6efd; color:white; padding:2px 8px; border-radius:10px; font-size:12px;">Step <span id="tourStepBadge">1</span></span>
    <div id="tourText" style="margin-top:5px; font-weight:bold;">æ¨™é¡Œ</div>
    <div id="tourSubText" style="font-size:13px; color:#666; margin-top:5px;">èªªæ˜</div>
    <div class="tour-actions"><button class="tour-skip-step" onclick="forceNextStep()">è·³éé€™ä¸€æ­¥ â”</button></div>
</div>

<div id="dimmer" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10001; display:none;"></div>

<div id="helpModal" class="modal-overlay" onclick="closeHelpModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-tabs">
            <div class="tab-btn active" onclick="switchTab('tab1')" id="btn-tab1">ğŸ“– æ“ä½œæµç¨‹</div>
            <div class="tab-btn" onclick="switchTab('tab2')" id="btn-tab2">ğŸ§ª åŸç†èˆ‡ä½ç½®</div>
            <button style="margin-left:auto; border:none; background:none; font-size:24px; cursor:pointer; padding:0 20px;" onclick="closeHelpModal()">Ã—</button>
        </div>
        <div id="tab1" class="modal-body active">
            <div class="important-box">
                <strong>âš ï¸ é‡è¦ç¬¬ä¸€æ­¥ï¼š</strong><br>
                è«‹ç¢ºä¿é€™å€‹ <code>.html</code> å·¥å…·æª”æ¡ˆï¼Œæ˜¯æ”¾åœ¨æ‚¨ <b>ã€Œç…§ç‰‡è³‡æ–™å¤¾çš„æœ€å¤–å±¤ã€</b>ã€‚<br>
                å¦‚æœæ˜¯ç›´æ¥å¾ç¶²è·¯ä¸‹è¼‰ï¼Œè«‹å…ˆå°‡å®ƒ <b>å‰ªä¸‹/è²¼ä¸Š</b> åˆ°æ‚¨çš„å·¥ä½œè³‡æ–™å¤¾ä¸­ã€‚
            </div>
            <div class="help-section">
                <div class="help-title">åŸºæœ¬æ“ä½œ SOP</div>
                <ul style="line-height:2;">
                    <li><b>æ­¥é©Ÿ 1 (æ•´ç†)ï¼š</b>é»æ“Šã€ŒğŸ“‚ é¸æ“‡è³‡æ–™å¤¾ã€è®€å–ç…§ç‰‡ã€‚</li>
                    <li><b>æ­¥é©Ÿ 2 (æ­¸æª”)ï¼š</b>ç”¨éµç›¤åˆ†é¡ã€åˆªé™¤ã€å‘½åç…§ç‰‡ã€‚</li>
                    <li><b>æ­¥é©Ÿ 3 (æª¢è¦–)ï¼š</b>åˆ©ç”¨ä¸Šæ–¹æŒ‰éˆ•åˆ‡æ›ã€Œå®Œæ•´/å°åœ–/1:1ã€æ¨¡å¼ã€‚</li>
                    <li><b>æ­¥é©Ÿ 4 (åŸ·è¡Œ)ï¼š</b>æŒ‰ã€Œâš¡ ä¸‹è¼‰æ•´ç†åŸ·è¡Œæª” (.bat)ã€ï¼Œä¸¦åŸ·è¡Œå®ƒã€‚</li>
                    <li><b>æ­¥é©Ÿ 5 (åƒç…§)ï¼š</b>ä¸‹è¼‰ã€Œåƒç…§è¡¨ã€ï¼Œç”¨ä¾†è¤‡è£½æª”åè²¼åˆ° Wordã€‚</li>
                </ul>
            </div>
            <div class="help-section">
                <div class="help-title">å¤§æ‰¹é‡åˆ†æ‰¹ä½œæ¥­æŠ€å·§</div>
                <p>è‹¥ç…§ç‰‡é«˜é” 1000 å¼µï¼Œå»ºè­°åˆ†æ‰¹è™•ç†ï¼ˆä¾‹å¦‚ä¸€æ¬¡ 300 å¼µï¼‰ã€‚</p>
                <p><b>å¦‚ä½•é¿å…æª”åé‡è¤‡ï¼Ÿ</b><br>
                åœ¨å·¦å´è¨­å®š <b>ã€ŒğŸ”¢ æµæ°´è™Ÿèµ·å§‹å€¼ã€</b>ã€‚ä¾‹å¦‚ç¬¬ä¸€æ‰¹åšå®Œ 300 å¼µï¼Œç¬¬äºŒæ‰¹è«‹å°‡èµ·å§‹å€¼è¨­ç‚º <b>301</b>ï¼Œé€™æ¨£æª”åå°±æœƒå¾ <code>_301</code> é–‹å§‹ï¼Œä¸æœƒè¦†è“‹èˆŠæª”æ¡ˆã€‚</p>
            </div>
        </div>
        <div id="tab2" class="modal-body">
            <div class="help-section">
                <div class="help-title">æª”æ¡ˆä½ç½®ç¤ºæ„åœ–</div>
                <div style="background:#333; color:white; padding:15px; border-radius:6px; font-family:monospace; line-height:1.5;">
                    ğŸ“‚ 2025æ´»å‹•ç…§ç‰‡ (æ‚¨çš„å·¥ä½œå€)<br>
                    â”œâ”€â”€ âš™ï¸ ç…§ç‰‡æ­¸æª”ç¥å™¨.html (æœ¬å·¥å…·)<br>
                    â”œâ”€â”€ âš™ï¸ é–‹å§‹æ•´ç†.bat (ç”¢ç”Ÿæª”)<br>
                    â”œâ”€â”€ ğŸ“„ åƒç…§è¡¨.html (ç”¢ç”Ÿæª”)<br>
                    â”œâ”€â”€ ğŸ“‚ æœƒè­°è¨˜éŒ„ (æ­¸æª”å¾Œ)<br>
                    â”œâ”€â”€ ğŸ“‚ ç¾å ´ç…§ç‰‡ (æ­¸æª”å¾Œ)<br>
                    â””â”€â”€ ğŸ“‚ _æœªåˆ†é¡ (è¢«è·³éçš„ç…§ç‰‡)
                </div>
            </div>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay" onclick="closeSettings()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button style="align-self:flex-end; border:none; background:none; font-size:24px; cursor:pointer;" onclick="closeSettings()">Ã—</button>
        <h2 style="margin-top:0;">ğŸ› ï¸ è¨­å®šåˆ†é¡èˆ‡æ¨™ç±¤</h2>
        <div class="settings-grid">
            <div class="settings-col">
                <h3>ğŸ“‚ ä¸»åˆ†é¡</h3>
                <table class="settings-table"><tbody id="catSettingsBody"></tbody></table>
                <button class="add-btn" onclick="addCatRow()">+ æ–°å¢</button>
            </div>
            <div class="settings-col">
                <h3>ğŸ·ï¸ å­æ¨™ç±¤</h3>
                <table class="settings-table"><tbody id="tagSettingsBody"></tbody></table>
                <button class="add-btn" onclick="addTagRow()">+ æ–°å¢</button>
            </div>
        </div>
        <button class="save-btn" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒè³‡æ–™ ---
    let categories = [ { name: "ç¯„ä¾‹åˆ†é¡A", key: "1" }, { name: "ç¯„ä¾‹åˆ†é¡B", key: "2" }, { name: "ç¯„ä¾‹åˆ†é¡C", key: "3" }, { name: "å…¶ä»–", key: "4" } ];
    let tags = [ { name: "ç¯„ä¾‹å¾Œç¶´1", key: "A" }, { name: "ç¯„ä¾‹å¾Œç¶´2", key: "S" }, { name: "ç¯„ä¾‹å¾Œç¶´3", key: "D" } ];
    
    let isDemoMode = true; 
    let isTourActive = false;
    let tourStep = 0;
    
    let demoData = { category: null, tags: new Set(), isDeleted: false, customName: "", isAuto: true };
    let files = [], fileData = [], currentIndex = 0;
    let keyMap = {}; 
    let rotationDeg = 0;
    let isLocked = false;
    let currentViewMode = 'fit';

    // --- DOM ---
    const UI = {
        img: document.getElementById('currentImage'),
        imgContainer: document.getElementById('imgContainer'), 
        infoBar: document.getElementById('infoBar'), 
        infoFilename: document.getElementById('infoFilename'), 
        infoProgress: document.getElementById('infoProgress'), 
        placeholder: document.getElementById('placeholder'),
        catContainer: document.getElementById('catContainer'),
        tagContainer: document.getElementById('tagContainer'),
        preview: document.getElementById('finalPreview'),
        uploadBtn: document.getElementById('uploadBtn'),
        downloadBtn: document.getElementById('downloadBtn'),
        reportBtn: document.getElementById('reportBtn'),
        trashOverlay: document.getElementById('trashOverlay'),
        welcomeOverlay: document.getElementById('welcomeOverlay'),
        dimmer: document.getElementById('dimmer'),
        tourTooltip: document.getElementById('tourTooltip'),
        helpModal: document.getElementById('helpModal'),
        settingsModal: document.getElementById('settingsModal'),
        autoSeqCheck: document.getElementById('autoSeqCheck'),
        customInput: document.getElementById('customInput'),
        lockBtn: document.getElementById('lockBtn'),
        startSeqInput: document.getElementById('startSeqInput')
    };

    // --- åˆå§‹åŒ– ---
    initUI();

    function initUI() {
        UI.catContainer.innerHTML = '';
        keyMap = {};
        categories.forEach(c => {
            const btn = document.createElement('div');
            btn.className = 'cat-btn';
            btn.id = `cat_${c.key}`; 
            btn.dataset.val = c.name;
            btn.innerHTML = `${c.name} ${c.key?`<span class="key-badge">${c.key}</span>`:''}`;
            btn.onclick = () => selectCategory(c.name);
            UI.catContainer.appendChild(btn);
            if(c.key) keyMap[c.key.toLowerCase()] = { type: 'cat', val: c.name };
        });

        UI.tagContainer.innerHTML = '';
        tags.forEach(t => {
            const btn = document.createElement('div');
            btn.className = 'tag-btn';
            btn.id = `tag_${t.key}`;
            btn.dataset.val = t.name;
            btn.innerHTML = `${t.name} ${t.key?`<span class="key-badge">${t.key}</span>`:''}`;
            btn.onclick = () => toggleTag(t.name);
            UI.tagContainer.appendChild(btn);
            if(t.key) keyMap[t.key.toLowerCase()] = { type: 'tag', val: t.name };
        });
    }

    // --- ä¸Šå‚³æª¢æŸ¥ ---
    function checkUpload() {
        if (isTourActive) { alert("è«‹å…ˆå®Œæˆæˆ–è·³éæ–°æ‰‹å°å¼•ï¼"); return false; }
        if (isDemoMode) {
            if(confirm("å³å°‡é›¢é–‹æ•™å­¸æ¨¡å¼ï¼Œä¸¦è¼‰å…¥çœŸå¯¦ç…§ç‰‡ã€‚ç¢ºå®šå—ï¼Ÿ")) {
                endDemoMode();
                return true; 
            }
            return false;
        }
        return true;
    }

    // --- æ ¸å¿ƒé‚è¼¯ ---
    function getData() { return isDemoMode ? demoData : fileData[currentIndex]; }

    function selectCategory(name) {
        if (isTourActive && tourStep === 1 && name !== categories[0].name) return; 
        let data = getData();
        if(data.isDeleted) { data.isDeleted = false; }
        data.category = name;
        updateUI();
        if(isTourActive && tourStep === 1 && name === categories[0].name) nextTourStep();
    }

    function toggleTag(name) {
        if (isTourActive && tourStep === 2 && name !== tags[0].name) return;
        let data = getData();
        if (data.tags.has(name)) data.tags.delete(name); else data.tags.add(name);
        updateUI();
        if(isTourActive && tourStep === 2 && data.tags.has(tags[0].name)) nextTourStep();
    }

    function markDeleted() {
        if (isTourActive && tourStep !== 3) return;
        let data = getData();
        data.isDeleted = !data.isDeleted;
        updateUI();
        if(isTourActive && tourStep === 3 && data.isDeleted) nextTourStep();
    }

    function toggleLock() {
        isLocked = !isLocked;
        UI.lockBtn.classList.toggle('active', isLocked);
        UI.lockBtn.innerHTML = isLocked ? "ğŸ”’ å·²é–å®š" : "ğŸ”“ é–å®šåˆ†é¡";
    }

    function rotateImage() {
        rotationDeg = (rotationDeg + 90) % 360;
        UI.img.style.transform = `rotate(${rotationDeg}deg)`;
    }

    // --- è¦–åœ–åˆ‡æ›é‚è¼¯ ---
    function changeView(mode) {
        currentViewMode = mode;
        
        // UIæŒ‰éˆ•ç‹€æ…‹æ›´æ–°
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        if(mode==='fit') document.querySelectorAll('.view-btn')[0].classList.add('active');
        if(mode==='small') document.querySelectorAll('.view-btn')[1].classList.add('active');
        if(mode==='1to1') document.querySelectorAll('.view-btn')[2].classList.add('active');

        // æ›´æ–°å®¹å™¨ Class
        UI.imgContainer.className = 'image-container'; // reset
        UI.imgContainer.classList.add(`view-${mode}`);
    }

    // 1to1 æ¨¡å¼æ‹–æ›³åŠŸèƒ½
    let isDragging = false, startX, startY, scrollLeft, scrollTop;
    UI.imgContainer.addEventListener('mousedown', (e) => {
        if(currentViewMode !== '1to1') return;
        isDragging = true;
        startX = e.pageX - UI.imgContainer.offsetLeft;
        startY = e.pageY - UI.imgContainer.offsetTop;
        scrollLeft = UI.imgContainer.scrollLeft;
        scrollTop = UI.imgContainer.scrollTop;
    });
    UI.imgContainer.addEventListener('mouseleave', () => { isDragging = false; });
    UI.imgContainer.addEventListener('mouseup', () => { isDragging = false; });
    UI.imgContainer.addEventListener('mousemove', (e) => {
        if(!isDragging) return;
        e.preventDefault();
        const x = e.pageX - UI.imgContainer.offsetLeft;
        const y = e.pageY - UI.imgContainer.offsetTop;
        const walkX = (x - startX) * 1; 
        const walkY = (y - startY) * 1;
        UI.imgContainer.scrollLeft = scrollLeft - walkX;
        UI.imgContainer.scrollTop = scrollTop - walkY;
    });

    // --- å‘½åæ§åˆ¶é‚è¼¯ ---
    function toggleNamingMode() {
        let data = getData();
        data.isAuto = UI.autoSeqCheck.checked;
        // æ³¨æ„ï¼šUI disable ç‹€æ…‹æœƒåœ¨ updateUI çµ±ä¸€è™•ç†ï¼Œé€™è£¡åªéœ€æ›´æ–°æ•¸æ“š
        if (!data.isAuto) {
            UI.customInput.disabled = false;
            UI.customInput.focus();
            data.customName = UI.customInput.value;
        }
        updateUI();
    }

    function onCustomInputChange(input) {
        let val = input.value.replace(/[\\/:*?"<>|]/g, ''); 
        input.value = val;
        let data = getData();
        data.customName = val;
        updateUI();
    }

    // --- å…±ç”¨æª”åç”Ÿæˆ ---
    function generateFilename(d, seqNum) {
        let parts = [d.category];
        tags.forEach(t => { if(d.tags.has(t.name)) parts.push(t.name); });

        let ext = "jpg"; 
        if(d.originalName) ext = d.originalName.split('.').pop().toLowerCase(); // çµ±ä¸€è½‰å°å¯«
        
        let finalName = "";
        
        // å–å¾—ä½¿ç”¨è€…è¨­å®šçš„èµ·å§‹å€¼ (é è¨­ç‚º 1)
        let startOffset = parseInt(UI.startSeqInput.value) || 1;
        
        if(d.isAuto !== false) { 
            let actualSeq = seqNum + startOffset - 1;
            let seqStr = String(actualSeq).padStart(3,'0');
            finalName = `${parts.join('_')}_${seqStr}.${ext}`;
        } else { 
            let cust = d.customName || "åç¨±";
            finalName = `${parts.join('_')}_${cust}.${ext}`;
        }
        return finalName;
    }

    function updateUI() {
        let data = getData();
        
        UI.trashOverlay.style.display = data.isDeleted ? 'flex' : 'none';
        
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', !data.isDeleted && b.dataset.val === data.category));
        document.querySelectorAll('.tag-btn').forEach(b => b.classList.toggle('active', data.tags.has(b.dataset.val)));

        UI.autoSeqCheck.checked = (data.isAuto !== false); 
        UI.customInput.value = data.customName || "";
        UI.customInput.disabled = UI.autoSeqCheck.checked;
        
        // è³‡è¨Šå„€è¡¨æ¿æ›´æ–°
        if(!isDemoMode) {
            UI.infoFilename.textContent = data.originalName;
            UI.infoProgress.textContent = `é€²åº¦: ${currentIndex + 1} / ${files.length}`;
        }

        if (data.isDeleted) {
            UI.preview.textContent = "ğŸ—‘ï¸ å°‡ç§»è‡³å›æ”¶æ¡¶";
            UI.preview.style.color = "#dc3545";
        } else if (!data.category) {
            UI.preview.textContent = "è«‹é¸æ“‡ä¸»åˆ†é¡...";
            UI.preview.style.color = "#666";
        } else {
            let seqNum = 1;
            if(!isDemoMode && data.category) {
                seqNum = 0;
                for(let i=0; i<=currentIndex; i++) {
                    if(fileData[i].category === data.category && !fileData[i].isDeleted) {
                        seqNum++;
                    }
                }
                if(seqNum === 0) seqNum = 1;
            }
            
            let finalName = generateFilename(data, seqNum);
            UI.preview.textContent = `å­˜æª”ç‚º: ${data.category}\\${finalName}`;
            UI.preview.style.color = "#333";
        }
    }
    
    // --- éµç›¤ç›£è½ ---
    document.addEventListener('keydown', (e) => {
        if (UI.welcomeOverlay.style.display !== 'none') return;
        if (UI.helpModal.style.display === 'flex' || UI.settingsModal.style.display === 'flex') return;
        if (document.activeElement === UI.customInput || document.activeElement === UI.startSeqInput) { 
            if(e.key === "Enter") nextImage(); 
            return; 
        }

        const key = e.key.toLowerCase();
        if (key === 'delete') markDeleted();
        else if (key === 'r') rotateImage();
        else if (key === 'enter' && !isDemoMode && !isTourActive) nextImage();
        else if (key === 'arrowleft' && !isDemoMode && !isTourActive) prevImage();
        else if (key === 'arrowright' && !isDemoMode && !isTourActive) nextImage();
        else if (keyMap[key]) {
            const act = keyMap[key];
            if (act.type === 'cat') selectCategory(act.val);
            if (act.type === 'tag') toggleTag(act.val);
            
            const btn = document.getElementById(`${act.type}_${key.toUpperCase()}`);
            if(btn) { btn.style.transform = "scale(0.95)"; setTimeout(()=>btn.style.transform="scale(1)", 100); }
        }
    });

    // --- å°è¦½æµç¨‹ ---
    function skipTour() { UI.welcomeOverlay.style.display = 'none'; endDemoMode(); }
    function startTour() {
        UI.welcomeOverlay.style.display = 'none';
        isTourActive = true;
        document.body.classList.add('tour-active');
        UI.img.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgODAwIDYwMCI+CiAgPHJlY3Qgd2lkdGg9IjgwMCIgaGVpZ2h0PSI2MDAiIGZpbGw9IiMzMzMiIC8+CiAgPHRleHQgeD0iNTA1IiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM4ODgiIGZvbnQtZmFtaWx5PSJNaWNyb3NvZnQgSmhlbmdIZWksIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMjQiPuabt+WbuuWcqOatpCAo6KKu5pSl6Yg45pW06auU54mHKTwvdGV4dD4KPC9zdmc+";
        UI.placeholder.style.display = 'none';
        UI.img.style.display = 'block';
        
        UI.dimmer.style.display = 'block';
        tourStep = 1; showTourStep(1);
    }
    function showTourStep(step) {
        document.querySelectorAll('.spotlight').forEach(el => { el.classList.remove('spotlight'); el.classList.remove('allow-click'); });
        const tooltip = UI.tourTooltip;
        tooltip.style.display = 'block';
        
        if(step===1) { setupTip(1, "é¸æ“‡ä¸»åˆ†é¡", `è«‹æŒ‰éµç›¤ '${categories[0].key}' é¸æ“‡ ${categories[0].name}`, `cat_${categories[0].key}`, 'right'); }
        else if(step===2) { setupTip(2, "åŠ ä¸Šå­æ¨™ç±¤", `è«‹æŒ‰éµç›¤ '${tags[0].key}' åŠ ä¸Š ${tags[0].name}`, `tag_${tags[0].key}`, 'right'); }
        else if(step===3) { setupTip(3, "åˆªé™¤å»¢ç‰‡", "æŒ‰ 'Delete' éµä¸Ÿæ£„ç…§ç‰‡", 'imgPanel', 'center'); }
        else if(step===4) {
            UI.dimmer.style.display = 'none'; tooltip.style.display = 'none';
            document.body.classList.remove('tour-active'); isTourActive = false;
            alert("ğŸ‰ ç·´ç¿’çµæŸï¼åŠŸèƒ½å…¨è§£é–ã€‚"); endDemoMode();
        }
    }
    function setupTip(num, title, desc, targetId, pos) {
        document.getElementById('tourStepBadge').innerText = num;
        document.getElementById('tourText').innerText = title;
        document.getElementById('tourSubText').innerText = desc;
        let el = document.getElementById(targetId);
        if(el) {
            el.classList.add('spotlight'); el.classList.add('allow-click');
            let rect = el.getBoundingClientRect();
            if(pos==='right') { UI.tourTooltip.style.top = rect.top+"px"; UI.tourTooltip.style.left = (rect.left - 320)+"px"; }
            else { UI.tourTooltip.style.top = "50%"; UI.tourTooltip.style.left = "50%"; UI.tourTooltip.style.transform = "translate(-50%, -50%)"; }
        }
    }
    function nextTourStep() { setTimeout(() => { tourStep++; showTourStep(tourStep); }, 500); }
    function forceNextStep() { nextTourStep(); }
    function endDemoMode() {
        isDemoMode = false;
        demoData = { category: null, tags: new Set(), isDeleted: false, isAuto: true };
        updateUI();
        
        UI.img.src = "";
        UI.img.style.display = 'none';
        UI.placeholder.style.display = 'block';
    }

    // --- çœŸå¯¦æª”æ¡ˆ ---
    document.getElementById('folderInput').addEventListener('change', function(e) {
        files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
        if (!files.length) { alert("æ²’æœ‰åœ–ç‰‡ï¼"); return; }
        
        fileData = files.map(f => ({ originalName: f.name, category: null, tags: new Set(), isDeleted: false, isAuto: true, customName: "" }));
        const collator = new Intl.Collator(undefined, {numeric: true, sensitivity: 'base'});
        files.sort((a, b) => collator.compare(a.name, b.name));
        fileData.sort((a, b) => collator.compare(a.originalName, b.originalName));
        
        currentIndex = 0; 
        
        // æ¿€æ´»ä¸‹è¼‰æŒ‰éˆ•
        UI.downloadBtn.classList.add('active'); 
        UI.reportBtn.classList.add('active'); 
        
        UI.placeholder.style.display = 'none';
        UI.img.style.display = 'block';
        UI.infoBar.style.display = 'flex'; 
        
        loadRealImage();
    });
    
    function loadRealImage() {
        if (!files.length) return;
        const img = document.getElementById('currentImage');
        if (img.src) URL.revokeObjectURL(img.src);
        img.src = URL.createObjectURL(files[currentIndex]);
        
        img.style.transform = "rotate(0deg)"; rotationDeg = 0;
        updateUI();
    }
    function nextImage() {
        if(currentIndex < files.length - 1) {
            let prevCat = fileData[currentIndex].category;
            currentIndex++;
            if(isLocked && prevCat && !fileData[currentIndex].category) {
                fileData[currentIndex].category = prevCat; 
            }
            loadRealImage();
        } else alert("ğŸ‰ å…¨éƒ¨å®Œæˆï¼");
    }
    function prevImage() { if(currentIndex > 0) { currentIndex--; loadRealImage(); } }

    // --- Modal èˆ‡ è¨­å®š ---
    function openHelpModal(tab) { UI.helpModal.style.display = 'flex'; switchTab(tab); }
    function closeHelpModal() { UI.helpModal.style.display = 'none'; }
    function switchTab(t) {
        document.querySelectorAll('.modal-body').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById(t).classList.add('active'); document.getElementById('btn-'+t).classList.add('active');
    }
    function openSettings() {
        const cBody = document.getElementById('catSettingsBody'); cBody.innerHTML = '';
        categories.forEach((c,i) => cBody.innerHTML += `<tr><td><input class="settings-input" value="${c.name}" onchange="categories[${i}].name=this.value"></td><td><input class="settings-input key-input" value="${c.key}" onchange="categories[${i}].key=this.value" maxlength="1"></td><td onclick="categories.splice(${i},1);openSettings()" style="color:red;cursor:pointer">âœ–</td></tr>`);
        const tBody = document.getElementById('tagSettingsBody'); tBody.innerHTML = '';
        tags.forEach((t,i) => tBody.innerHTML += `<tr><td><input class="settings-input" value="${t.name}" onchange="tags[${i}].name=this.value"></td><td><input class="settings-input key-input" value="${t.key}" onchange="tags[${i}].key=this.value" maxlength="1"></td><td onclick="tags.splice(${i},1);openSettings()" style="color:red;cursor:pointer">âœ–</td></tr>`);
        UI.settingsModal.style.display = 'flex';
    }
    function closeSettings() { UI.settingsModal.style.display = 'none'; }
    function saveSettings() {
        initUI(); 
        closeSettings();
        updateUI(); 
    }
    function addCatRow() { categories.push({name:"", key:""}); openSettings(); }
    function addTagRow() { tags.push({name:"", key:""}); openSettings(); }

    // --- Export BAT ---
    function exportBat() {
        if(isDemoMode) { alert("è«‹å…ˆè¼‰å…¥çœŸå¯¦ç…§ç‰‡ï¼"); return; }
        if(!files.length) return;
        let bat = "@echo off\r\nchcp 65001 >nul\r\necho æ­£åœ¨æ•´ç†ç…§ç‰‡...\r\n\r\n";
        
        let folders = new Set(); folders.add("_TRASH");
        
        // å…ˆå»ºç«‹æ­£å¸¸åˆ†é¡çš„è³‡æ–™å¤¾
        fileData.forEach(d => { if(d.category && !d.isDeleted) folders.add(d.category); });
        folders.forEach(f => bat += `if not exist "${f}" md "${f}"\r\n`);
        bat += "\r\n";

        let counts = {};
        let unsortedCount = 0;
        
        fileData.forEach(d => {
            if(d.isDeleted) { 
                bat += `move "${d.originalName}" "_TRASH\\${d.originalName}"\r\n`; 
                return; 
            }
            
            if(!d.category) {
                if(!folders.has("_æœªåˆ†é¡")) { 
                    folders.add("_æœªåˆ†é¡"); 
                    bat += `if not exist "_æœªåˆ†é¡" md "_æœªåˆ†é¡"\r\n`; 
                }
                bat += `move "${d.originalName}" "_æœªåˆ†é¡\\${d.originalName}"\r\n`;
                unsortedCount++;
                return;
            }
            
            if(!counts[d.category]) counts[d.category]=0;
            counts[d.category]++;
            
            let finalName = generateFilename(d, counts[d.category]);
            bat += `move "${d.originalName}" "${d.category}\\${finalName}"\r\n`;
        });
        
        bat += `\r\necho æ•´ç†å®Œæˆï¼ (å« ${unsortedCount} å¼µæœªåˆ†é¡)\r\npause`;
        
        const blob = new Blob([bat], {type: 'text/plain;charset=utf-8'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "é–‹å§‹æ•´ç†.bat";
        link.click();
    }

    // --- Export Minimalist Reference List ---
    function exportReport() {
        if(isDemoMode) { alert("è«‹å…ˆè¼‰å…¥çœŸå¯¦ç…§ç‰‡ï¼"); return; }
        if(!files.length) return;

        // æ³¨å…¥ JS è…³æœ¬å¯¦ç¾é»æ“Šè¤‡è£½
        let script = `
        <script>
            function copyText(el) {
                let text = el.innerText;
                navigator.clipboard.writeText(text).then(() => {
                    let originalText = el.innerText;
                    el.classList.add('copied');
                    el.innerText = 'âœ… å·²è¤‡è£½';
                    setTimeout(() => {
                        el.classList.remove('copied');
                        el.innerText = originalText;
                    }, 1000);
                });
            }
        <\/script>
        `;

        let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>æª”æ¡ˆåƒç…§è¡¨ (é»æ“Šè¤‡è£½)</title>
            <style>
                body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background: #f8f9fa; }
                .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
                h2 { color: #555; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-top: 30px; }
                table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
                th { background: #eee; padding: 8px; text-align: left; color:#666; font-size:14px; }
                td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: middle; }
                
                .index-col { width: 40px; color: #999; font-size: 13px; text-align: center; }
                .thumb { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; display:block; }
                
                /* æŒ‰éˆ•æ¨£å¼ */
                .copy-btn { 
                    display: inline-block; padding: 8px 15px; 
                    background: #e7f1ff; color: #0d6efd; 
                    border: 1px solid #b6d4fe; border-radius: 4px; 
                    font-weight: bold; cursor: pointer; user-select: none; transition: 0.2s;
                    min-width: 200px; text-align: center;
                }
                .copy-btn:hover { background: #0d6efd; color: white; }
                .copy-btn:active { transform: scale(0.98); }
                .copy-btn.copied { background: #198754; color: white; border-color: #198754; pointer-events: none; }
                
                .note { background: #e2e3e5; color: #383d41; padding: 10px; margin-bottom: 20px; border-radius: 5px; font-size: 14px; }
            </style>
            ${script}
        </head>
        <body>
            <div class="container">
                <h1>ğŸ“„ æª”æ¡ˆåƒç…§è¡¨ (é»æ“Šè¤‡è£½)</h1>
                <div class="note">
                    <strong>ğŸ’¡ ä½¿ç”¨æ–¹å¼ï¼š</strong><br>
                    åœ¨ Word æ’å…¥åœ–ç‰‡å¾Œï¼Œé»æ“Šä¸‹æ–¹çš„ <b>è—è‰²æŒ‰éˆ•</b> è¤‡è£½æª”åï¼Œç„¶å¾Œç›´æ¥è²¼ä¸Šã€‚
                </div>
        `;

        let globalCounts = {};
        
        // ä¾ç…§åˆ†é¡é¡¯ç¤º
        categories.forEach(cat => {
            let catPhotos = fileData.filter(d => !d.isDeleted && d.category === cat.name);
            
            if (catPhotos.length > 0) {
                html += `<h2>ğŸ“‚ ${cat.name}</h2>`;
                html += `<table><thead><tr><th class="index-col">#</th><th width="100">ç¸®åœ–</th><th>é»æ“ŠæŒ‰éˆ•è¤‡è£½æª”å</th></tr></thead><tbody>`;

                let rowNum = 1;
                catPhotos.forEach((d) => {
                    if(!globalCounts[d.category]) globalCounts[d.category]=0;
                    globalCounts[d.category]++;
                    
                    let finalName = generateFilename(d, globalCounts[d.category]);
                    let ext = d.originalName.split('.').pop().toLowerCase();
                    let captionText = finalName.replace('.'+ext, '');
                    let relPath = `${d.category}/${finalName}`;

                    html += `
                        <tr>
                            <td class="index-col">${rowNum++}</td>
                            <td><img src="${relPath}" class="thumb" loading="lazy"></td>
                            <td>
                                <div class="copy-btn" onclick="copyText(this)">${captionText}</div>
                            </td>
                        </tr>
                    `;
                });
                html += `</tbody></table>`;
            }
        });

        html += `</div></body></html>`;

        const blob = new Blob([html], {type: 'text/html;charset=utf-8'});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "åƒç…§è¡¨.html";
        link.click();
    }
</script>
</body>
</html>
